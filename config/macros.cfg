###########################################################
#      Mesasage on Printer startup:
###########################################################

[delayed_gcode strartup_message]   
initial_duration: 1
gcode:
    ## <if> Load and set language variables:
	{% if printer.save_variables.variables.lang == 2 %} {% set lang = 2 | int %} {% elif printer.save_variables.variables.lang == 3 %} {% set lang = 3 | int %} {% endif %}
    M118 { "Pro počáteční Z home navádění se doporučuje předehřát trysku, nebo použijte makro:" if lang == 2 else "Zur anfänglichen Z-Home-Führung wird empfohlen, die Düse vorzuwärmen oder ein Makro zu verwenden:" if lang == 3 else "For initial Z homing it is recommended to preheat the nozzle, or use the macro:" } <a class="command font-weight-bold">Temp_Homing</a>


###########################################################
#      Kliper Base macro for Mainsail main page macro button:
###########################################################
## If it is there, you can then add a custom button for Klipper 
## Base macros (like BED_MESH_CALIBRATE button) to the Mainsail main page. 

## The macros are numbered in the order needed to perform offset calibration 
## Steps 01 and 02 are calibration for the Z Proximity inductive Probe and 3D-Touch.

[gcode_macro Z_ENDSTOP_CALIBRATE_01]
description: Z Endstop Calibrate macro button
gcode:	
	Z_ENDSTOP_CALIBRATE

[gcode_macro PROBE_CALIBRATE_02]
description: Probe Calibrate macro button
gcode:	
	PROBE_CALIBRATE

[gcode_macro Z_TILT_ADJUST_03]
description: Z Tilt Adjust macro button
gcode:	
	Z_TILT_ADJUST

[gcode_macro BED_MESH_CALIBRATE_04]
description: Bed Mesh Calibrate macro button
gcode:	
	BED_MESH_CALIBRATE


###########################################################
#      Gcode FEATURES:
###########################################################

## podpora G2/G3
[gcode_arcs]        
resolution: 1.0

## For M118 messages to Mainsail command line:
[respond]            
default_type: echo
default_prefix: 

#[virtual_sdcard]     ## Include in Mainsail
#path: ~/printer_data/gcodes/  

## podpora ukládání hodnot, po restartu např.
[save_variables]     
filename: ~/printer_data/config/variables.cfg    

## Pauza
[pause_resume]
recover_velocity: 50   # (mm/s). Default is 50.0 mm/s.

[exclude_object]

## Skew korekce
[skew_correction]

[force_move]  # For Bedlowrider macro
enable_force_move: true


######################################################################
#      Homing with heated nozzle - Secure homing macro:
######################################################################

[gcode_macro Temp_Homing]
description: Homing with pre-heated nozzle
gcode:
    {% if printer.save_variables.variables.lang == 2 %} {% set lang = 2 | int %} {% elif printer.save_variables.variables.lang == 3 %} {% set lang = 3 | int %} {% endif %} 
    {% set target_temp = printer.extruder.target | int %}
	M117 { "XYZ Navadeni..." if lang == 2 else "XYZ Referenzen" if lang == 3 else "XYZ Homing..." }
    M118 { "XYZ Domovská pozice..." if lang == 2 else "XYZ Referenzfahrt..." if lang == 3 else "XYZ Homing..." }
    {% if printer.extruder.temperature < 100 %}
       M117 { "Cekam na nahrati" if lang == 2 else "Temp warten..." if lang == 3 else "Temp wait..." } 
          M118 { "Studená tryska, nahřívám Extruder na 100°C, poté XYZ navádění..." if lang == 2 else "Kalte Düse, Aufheizen des Extruders auf 100 °C, dann XYZ-Homing..." if lang == 3 else "Cold nozzle, heating the Extruder to 100 °C, then XYZ homing..." }
       M109 S100 
    {% endif %}
	G28
    M400                                                                        # Wait for the moves to complete for message below
    M104 S{target_temp}                                                         # Restore Extruder target Temp to previous, no wait
	M118 { "Předehřáté XYZ navádění dokončeno. Cílová teplota Extrudéru byla obnovena na předchozích" if lang == 2 else "Vorgewärmtes Homing abgeschlossen. Zieltemperatur des Extruders auf vorherigen Wert zurückgesetzt" if lang == 3 else "Pre-heated homing complete. Extruder target temp restored to previous" } {target_temp}°C.


######################################################################
#      Filament Runout Sensor and Runout Distance:
######################################################################
## description: Adjustable distance delay (to run PAUSE) triggered when filament sensor is activated to save filament.
## Distance = Length from filament runout switch to extruder gear (set to <distance> variable below with some reserve).
## Filament sensor connected to Octopus Board pin: PG11

[filament_switch_sensor Filament_Sensor]
switch_pin: PG11
pause_delay: 0.1
event_delay: 3.0
pause_on_runout: False
# insert_gcode: {action_respond_info("RUNOUT: Filament inserted")}
runout_gcode:
          {action_respond_info("RUNOUT: Filament runout")}
          runout_distance

## Filament Runout Distance:
[gcode_macro runout_distance]
description: Filament Runout Distance
variable_distance_end: 0
gcode:
   {% set distance = 930 %}                                              ## <<<< ADJUSTABLE LENGTH of PTFE tube (in mm, from filament sensor to extruder gear) - Rename 930 to your own PTFE length with added about -100mm reserve.
   {% set start_point = printer.print_stats.filament_used | int %}                                  # Save filament used stats when runout_distance macro is called
   {% set end_point = (start_point + distance) | int %}                                             # Calculate end point to run Pause
   SET_GCODE_VARIABLE MACRO=runout_distance VARIABLE=distance_end VALUE={end_point}                 # Write the <end_point> value to the <distance_end> variable to access later
   UPDATE_DELAYED_GCODE ID=runout_check DURATION=1                                                  # Run the delayed gcode below after 1 second

[delayed_gcode runout_check]
initial_duration: 0                                                                                 # If initial_duration is zero, the delayed gcode won't start by default
gcode:
   {% if printer.save_variables.variables.lang == 2 %} {% set lang = 2 | int %} {% elif printer.save_variables.variables.lang == 3 %} {% set lang = 3 | int %} {% endif %} 
   {% set length_used = printer.print_stats.filament_used | int %}                                  # Get the actual filament used
   {% set length_ctdown = (printer["gcode_macro runout_distance"].distance_end) - length_used %}    # Length Countdown for below M117 display show
   {% if length_used < printer["gcode_macro runout_distance"].distance_end %}                       # If we aren't at the <end_point> value
      M117 { "Pauza za:" if lang == 2 else "Pause bei:" if lang == 3 else "Pause at:" } {length_ctdown} mm
      UPDATE_DELAYED_GCODE ID=runout_check DURATION=1                                               # Run <runout_check> again than 1 sec - looping
   {% else %}
      M600                                                                                          # Pause, Park and Filament Change
      Red_Blink                                                                                     # LED Lights blink macro
      # M300 P300 S400                                                                              # Beeper, example
      UPDATE_DELAYED_GCODE ID=runout_check DURATION=0                                               # Turn off delayed <runout_check> loop
   {% endif %}

          
######################################################################
#      Filament Change M600:
######################################################################
# M600: Filament Change. This macro will Pause the print, move the
# tool to the Park position, and Unload 100mm filament. Adjust
# the unload settings for your own extruder (in <FILAMENT_UNLOAD> 
# macro). After filament has been changed, the print can be resumed from 
# its previous position via the "RESUME" Mainsail button.

[gcode_macro M600] 
description: Filament Change
gcode:
    SAVE_GCODE_STATE NAME=M600
    {% set target_temp = printer.extruder.target | int %}                # Save Extruder target temp while printing.
	{% set change_temp = params.TEMP|default(200)|int %}                 # For customize change temp on macro button (default 200°C for PLA) - for NON Printing Filament Change button use.
    {% if printer.idle_timeout.state == "Printing" %}                   ## Gcode below is for Filament Change when Printing is becomes to Pause:
       PAUSE                                                             # Mainsail macro - Pause print and park toolhead, with z hop.
       FILAMENT_UNLOAD TEMP={target_temp}                                # Run <FILAMENT_UNLOAD> macro with <TEMP> parameter.
    {% else %}                                                          ## Gcode below is for NON Printing Filament Change via Mainsail macro button with customize TEMP parameter (default 200°C for PLA):
	   M104 S{change_temp}                                               # Set Extruder Target Temp for restore (not restore) temp on the end of <FILAMENT_UNLOAD> macro, due to next <filament Load>.
       FILAMENT_UNLOAD TEMP={change_temp}                                # Run <FILAMENT_UNLOAD> macro with <TEMP> parameter, <FILAMENT_UNLOAD> Park Toolhead and UNLOAD Filament
    {% endif %}
    RESTORE_GCODE_STATE NAME=M600


################################################################################
#      Filament Load / Unload:
################################################################################

[gcode_macro FILAMENT_LOAD]
description: Filament Load 100mm
gcode:
    SAVE_GCODE_STATE NAME=filament_load
    {% if printer.save_variables.variables.lang == 2 %} {% set lang = 2 | int %} {% elif printer.save_variables.variables.lang == 3 %} {% set lang = 3 | int %} {% endif %} 
    {% set target_temp = printer.extruder.target | int %}                # Save Extruder target temp for restore on the end of this macro.
	{% set load_temp = params.TEMP|default(200)|int %}                   # For customize unload temp via Mainsal macro button, default 200°C for PLA
	{% if printer.pause_resume.is_paused  == False %}                    # For NON printig usage --> Park Toolhead (For Loading filament outside bed).
       Park_Toolhead
	{% endif %}
	{% if printer.extruder.temperature < load_temp %}                    # Heat Nozzle to <load_temp> (Only if temp is below) and wait.
       M117 { "Nahrivam trysku" if lang == 2 else "Erhitzen der Duse" if lang == 3 else "Heating Nozzle" }
       M118 { "Nahřívám trysku na:" if lang == 2 else "Aufheizen der Düse auf:" if lang == 3 else "Heating the nozzle to:" } {load_temp}°C...
       M109 S{load_temp}
    {% endif %}
	M117 { "Zavadim filament" if lang == 2 else "Filament laden" if lang == 3 else "Loading filament" }
    M118 { "Zavádím Filament..." if lang == 2 else "Filament laden..." if lang == 3 else "Loading Filament..." }
    M83
    G92 E0.0
    G1 E100 F240                                                         # Filament Load (100mm, 4mm/s)
    G92 E0.0
    M82
    M400                                                                 # Wait for the moves to complete, for message below
    M117 { "Filament zaveden" if lang == 2 else "Laden fertig" if lang == 3 else "Load Complete" }
    M118 { "Filament zaveden. Cílová teplota Extrudéru byla obnovena na předchozích" if lang == 2 else "Filament geladen. Zieltemperatur des Extruders auf vorherigen Wert zurückgesetzt" if lang == 3 else "Load Complete. Extruder target temp restored to previous" } {target_temp}°C.
    M104 S{target_temp}                                                  # Restore Extruder target Temp to previous, no wait    
    RESTORE_GCODE_STATE NAME=filament_load

[gcode_macro FILAMENT_UNLOAD]
description: Filament Unload 100mm
gcode:
    SAVE_GCODE_STATE NAME=filament_unload
    {% if printer.save_variables.variables.lang == 2 %} {% set lang = 2 | int %} {% elif printer.save_variables.variables.lang == 3 %} {% set lang = 3 | int %} {% endif %} 
    {% set target_temp = printer.extruder.target | int %}
	{% set unload_temp = params.TEMP|default(200)|int %}                 # For customize unload temp via Mainsal macro button, default 200°C for PLA
	{% if printer.pause_resume.is_paused  == False %}                    # For NON M600 usage when printig --> Park Toolhead (For Loading filament outside bed).
       Park_Toolhead
	{% endif %}	
 	{% if printer.extruder.temperature < unload_temp %}                  # Heat Nozzle to <unload_temp> (Only if temp is below) and wait
       M117 { "Nahrivam trysku" if lang == 2 else "Erhitzen der Duse" if lang == 3 else "Heating Nozzle" }
       M118 { "Nahřívám trysku na:" if lang == 2 else "Aufheizen der Düse auf:" if lang == 3 else "Heating the nozzle to:" } {unload_temp}°C...
       M109 S{unload_temp}
    {% endif %}
    M117 { "Vysun filamentu" if lang == 2 else "Filament entladen" if lang == 3 else "Unloading fil." }
    M118 { "Vysouvám Filament..." if lang == 2 else "Filament entladen..." if lang == 3 else "Unloading Filament..." }
    M83                                                                  # Put the extruder into relative mode
    G92 E0.0                                                             # Reset the extruder at position zero
	G1 E7 F180                                                           # Initial Load (7mm, 3mm/s)
    G1 E-7 F300                                                          # Initial Unload (7mm, 5mm/s)
    G4 P5000                                                             # Delay 5 sec 
    G1 E-100 F300                                                        # Full Filament Unload (100mm, 5mm/s)
    G92 E0.0                                                             # Set E position (Reset the extruder again)
    M82                                                                  # Put the extruder back into absolute mode.
    M400                                                                 # Wait for the moves to complete, for message below
	M117 { "Filament vysunut" if lang == 2 else "Entladen abgeschlossen" if lang == 3 else "Unload Complete" }
    M118 { "Filament vysunut. Cílová teplota Extrudéru byla obnovena na předchozích" if lang == 2 else "Entladen abgeschlosse. Zieltemperatur des Extruders auf vorherigen Wert zurückgesetzt" if lang == 3 else "Unload Complete. Extruder target temp restored to previous" } {target_temp}°C.
    M104 S{target_temp}                                                  # Restore Extruder target Temp to previous, no wait
    e_stepper_off                                                        # OFF E stepper for better initial manual insertion new filament into gear   
    RESTORE_GCODE_STATE NAME=filament_unload


################################################################################
#      Nozzle Clean (via Brush):
################################################################################

[gcode_macro Nozzle_Clean]
description: Wipe nozzle by brush
gcode:
    SAVE_GCODE_STATE NAME=nozzle_clean
    {% if printer.save_variables.variables.lang == 2 %} {% set lang = 2 | int %} {% elif printer.save_variables.variables.lang == 3 %} {% set lang = 3 | int %} {% endif %} 
    M117 { "Cisteni trysky" if lang == 2 else "Dusenreinigung" if lang == 3 else "Nozzle cleaning" }
    M118 { "Čištění trysky..." if lang == 2 else "Düsenreinigung..." if lang == 3 else "Nozzle cleaning..." }
	{% set target_temp = printer.extruder.target | int %}	             # Save Extruder target temp for restore on the end of this macro.
    {% set wipe_speed = 4800 %}                                          # Wipe speed in mm/min, (3000 = 50mm/s, 4800 = 80mm/s, 6000 = 100mm/s).
    {% set wipe_count = params.COUNT|default(1)|int %}                   # Adjustable params <COUNT> on macro button. Number of clean procedure moves over brush.
	{% if "xyz" not in printer.toolhead.homed_axes %}                    # If isnt homed - Go Home with a slightly HEATED nozzle for the Z home procedure.
       M117 { "Prvne domu..." if lang == 2 else "Zuerst Homing..." if lang == 3 else "Homing first..." }
       M118 { "Neznámá pozice! - Spouštím XYZ Auto-Navádění" if lang == 2 else "Nicht gehomed! - Automatisches Homing wird ausgeführt..." if lang == 3 else "Not Homed! - Running Auto-Homing..." }
       {% if printer.extruder.temperature < 110 %}                       # Set Nozzle Temp to 110°C (if temp is below), for secure Z homing.
          M118 { "Studená tryska, nahřívám Extruder na 110°C, poté XYZ navádění..." if lang == 2 else "Kalte Düse, Aufheizen des Extruders auf 110 °C, dann XYZ-Homing..." if lang == 3 else "Cold nozzle, heating the Extruder to 110 °C, then XYZ homing..." }
          M109 S110 
       {% endif %}
	   G28
	{% endif %}
    {% if printer.toolhead.position.z < 10 %}                            # First lift Z axis, only if Z height is below 10mm
	   G90
	   G1 Z10 F600
	{% endif %}
	G90                                                                  # Absolute positioning XYZ.    
    G1 Y251.5 F2700                                                      # Go to Start brush position, long G1 write, XY Core does not like diagonal movement.
    G1 X149 F2700
    G1 Z10 F600  
	{% if printer.extruder.temperature > 170 %}                          # Heat or Cool down Extruder to 170°C and wait.
       M117 { "Chlazeni trysky" if lang == 2 else "Kuhlduse" if lang == 3 else "Cooling Nozzle" }
       M118 { "Čekám na ochlazení trysky na 170 °C pomocí ventilátoru" if lang == 2 else "Warten, bis die Düse durch den Ventilator auf 170 °C abgekühlt ist..." if lang == 3 else "Waiting for nozzle to cool down at 170°C by Fan..." }
       M106 S255                                                         # Part cooling FAN ON at 100% (255 = 100%)
       M109 S170                                                         # Set Nozzle temp to 170°C and wait for cooling down
       M106 S0                                                           # Part cooling FAN OFF
    {% else %}
       M117 { "Nahrivam trysku" if lang == 2 else "Erhitzen der Duse" if lang == 3 else "Heating Nozzle" }
       M118 { "Nahřívám trysku na 170°C..." if lang == 2 else "Aufheizen der Düse auf 170°C..." if lang == 3 else "Heating the nozzle to 170°C..." }
       M109 S170
    {% endif %}
    M104 S0                                                              # Extruder target Temp to 0 no wait - start cooling at now.
    G1 Z0.6 F600                                                         # Go down to the brush clean level.
    {% for wipe in range (wipe_count) %}
	  {% for move_right in range (14) %}                                 ## Moves to the Right:         Start >>|   /|   /|   /|   /|   /o  End
         G91                                                             # Relative positioning XYZ             |  / |  / |  / |  / |  / 
	     G1 Y-11 F{wipe_speed}                                           # Y Move to Front                      | /  | /  | /  | /  | / 
	     G1 X3 Y11 F{wipe_speed}                                         # XY Move to Right and Back            |/   |/   |/   |/   |/  
      {% endfor %}
	
	  {% for move_left in range (14) %}                                  ## Moves to the Left:             End  o\   |\   |\   |\   |\   |<< Start
         G91                                                             # Relative positioning XYZ               \  | \  | \  | \  | \  |
	     G1 Y-11 F{wipe_speed}                                           # Y Move to Front                         \ |  \ |  \ |  \ |  \ |
	     G1 X-3 Y11 F{wipe_speed}                                        # XY Move to Left and Back                 \|   \|   \|   \|   \|
      {% endfor %}
   {% endfor %} 
    M400                                                                 # Wait for current moves to finish.
    ## Removing filament leak from nozzle:
	M117 { "Chlazeni trysky" if lang == 2 else "Kuhlduse" if lang == 3 else "Cooling Nozzle" }
    M118 { "Čekám na ochlazení trysky na 155 °C pomocí ventilátoru" if lang == 2 else "Warten, bis die Düse durch den Ventilator auf 155 °C abgekühlt ist..." if lang == 3 else "Waiting for nozzle to cool down at 155°C by Fan..." }
    M106 S255                                                            # Part cooling FAN ON at 100% (255 = 100%)
    M109 S155                                                            # Wait for nozzle cool down at 155°C by fan
    M104 S{target_temp}                                                  # Restore Extruder target Temp to previous, no wait - start cooling at now.
    {% for wipe in range (wipe_count) %}
	  {% for move_right in range (14) %}                                 ## Moves to the Right:         Start >>|   /|   /|   /|   /|   /o  End
         G91                                                             # Relative positioning XYZ             |  / |  / |  / |  / |  / 
	     G1 Y-11 F{wipe_speed}                                           # Y Move to Front                      | /  | /  | /  | /  | / 
	     G1 X3 Y11 F{wipe_speed}                                         # XY Move to Right and Back            |/   |/   |/   |/   |/  
      {% endfor %}
	
	  {% for move_left in range (14) %}                                  ## Moves to the Left:             End  o\   |\   |\   |\   |\   |<< Start
         G91                                                             # Relative positioning XYZ               \  | \  | \  | \  | \  |
	     G1 Y-11 F{wipe_speed}                                           # Y Move to Front                         \ |  \ |  \ |  \ |  \ |
	     G1 X-3 Y11 F{wipe_speed}                                        # XY Move to Left and Back                 \|   \|   \|   \|   \|
      {% endfor %}
   {% endfor %}             
    G90                                                                  # Absolute positioning XYZ.
    G1 Z10 F600                                                          # Lift on the End (to absolute Z10), 10mm/s
    M106 S0                                                              # Part cooling FAN Off
    M400                                                                 # Wait for current moves to finish (For messages below).
    M117 { "Cisteni dokonc." if lang == 2 else "Reinigung erled." if lang == 3 else "Cleaning done" }
    M118 { "Čištění trysky dokončeno. Cílová teplota Extrudéru byla obnovena na předchozích" if lang == 2 else "Düsenreinigung abgeschlossen. Zieltemperatur des Extruders auf vorherigen wert zurückgesetzt" if lang == 3 else "Nozzle cleaning done. Extruder target temp restored to previous" } {target_temp}°C.
    RESTORE_GCODE_STATE NAME=nozzle_clean


################################################################################
#      Moves Macro:
################################################################################

[gcode_macro FAKE_POSITION]
gcode:
    SET_KINEMATIC_POSITION X=100 Y=100 Z=100
 
[gcode_macro steppers_off]
description: All steppers OFF
gcode:
    {% if printer.save_variables.variables.lang == 2 %} {% set lang = 2 | int %} {% elif printer.save_variables.variables.lang == 3 %} {% set lang = 3 | int %} {% endif %}
    M117 { "Motory vypnuty" if lang == 2 else "Motoren aus" if lang == 3 else "Steppers off" }
    M118 { "Motory vypnuty" if lang == 2 else "Schrittmotoren aus" if lang == 3 else "Stepper motors off" }
    M84
    M18                                                                  # steppers off
    UPDATE_DELAYED_GCODE ID=clear_display DURATION=25                    # clear display

[gcode_macro e_stepper_off]
description: E Stepper Off
gcode:
    {% if printer.save_variables.variables.lang == 2 %} {% set lang = 2 | int %} {% elif printer.save_variables.variables.lang == 3 %} {% set lang = 3 | int %} {% endif %} 
    M117 { "E motor vypnut" if lang == 2 else "E motor aus" if lang == 3 else "E stepper off" }
    M118 { "E motor vypnut" if lang == 2 else "E motor aus" if lang == 3 else "E stepper off" }
    SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
    UPDATE_DELAYED_GCODE ID=clear_display DURATION=25                    # Clear LCD display after last message at 25 sec


################################################################################
#      Park Toolhead (Custom front position):
################################################################################

[gcode_macro Park_Toolhead]                                              # Park Toolhead, same coordinate as in Mainsail PAUSE and PARK macro.
description: Park Toolhead 
gcode:
	{% if printer.save_variables.variables.lang == 2 %} {% set lang = 2 | int %} {% elif printer.save_variables.variables.lang == 3 %} {% set lang = 3 | int %} {% endif %} 
    SAVE_GCODE_STATE NAME=park
	{% set zet_pos = printer.toolhead.position.z %}
    {% if "xy" not in printer.toolhead.homed_axes %}
       M117 { "Prvne domu..." if lang == 2 else "Zuerst Homing..." if lang == 3 else "Homing first..." }
       M118 { "Prvně domů (pouze XY)..." if lang == 2 else "Zuerst homing (nur XY)..." if lang == 3 else "Homing first (only XY)..." }	   
	   G28 X Y
	{% endif %}
    M117 { "Parkuji..." if lang == 2 else "Ich parke..." if lang == 3 else "Parking..." }
    M118 { "Parkuji..." if lang == 2 else "Ich parke..." if lang == 3 else "Parking toolhead..." }
    {% if zet_pos < 10 %}                                                # First lift Z axis, only if Z height is below 10mm
	   G90
	   G1 Z10 F600
	{% endif %}
	G90
    G1 Y-10 F2700    
    G1 X50 F2700                                                         # Go to Park position, long G1 write, XY Core does not like diagonal movement.
	RESTORE_GCODE_STATE NAME=park


################################################################################
#      Idle Timeout:
################################################################################

[idle_timeout]
timeout: 480  # 300 = 5min, 480 = 8min
gcode:
    {% if printer.save_variables.variables.lang == 2 %} {% set lang = 2 | int %} {% elif printer.save_variables.variables.lang == 3 %} {% set lang = 3 | int %} {% endif %}
    {% if printer.pause_resume.is_paused %}
         SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=idle_state VALUE=True  # For Mainsail_custom.cfg RESUME macro
         {action_respond_info("Hotend powered down on idle timeout.")}
         M117 { "Hotend Vypnut" if lang == 2 else "Hotend AUS" if lang == 3 else "Hotend OFF" }
         M118 { "Hotend Vypnut" if lang == 2 else "Hotend AUS" if lang == 3 else "Hotend OFF" }
         M104 S0                                                         # Hotend OFF
         M106 S0                                                         # Blower Fan OFF (speed 0 - 255)
         Green_Blink
    {% else %}
         M117 { "Vyprsel cas" if lang == 2 else "Leerlauf-Timeout" if lang == 3 else "Idle Timeout" }
         M118 { "Čas nečinosti vypršel" if lang == 2 else "Leerlauf-Timeout" if lang == 3 else "Idle Timeout" }	
         Green_Blink                                                     # LED Lights Blinks
         TURN_OFF_HEATERS                                                # All Heaters OFF
         M84                                                             # Steppers OFF
         M106 S0                                                         # Blower Fan OFF (speed 0 - 255)
         UPDATE_DELAYED_GCODE ID=clear_display DURATION=25
    {% endif %}
    M117 { "Tisk. pripravena" if lang == 2 else "Bereit" if lang == 3 else "Ready" }

################################################################################
#      Display cleer:
################################################################################
## Dispaly clear Command (with delay 25 sec):
## Gcode usage: UPDATE_DELAYED_GCODE ID=clear_display DURATION=25

[delayed_gcode clear_display]                                            # if M117 is empty --> clear display
gcode:
    M117


################################################################################
#      Remotely control printer power ON and OFF via Relay:
################################################################################
## The original code and setup instructions can be found at: https://github.com/tinntbg/auto-power-off-klipper 
## For remote control power ON/OFF by Relay it is need add somewhere to moonraker.conf file codes below:
##
## [power printer]
## type: gpio
## pin: gpiochip0/gpio72               # can be revesed by "!" , BTT-PI GPIO pin PC8
## initial_state: off  
## off_when_shutdown: True             # Turning off when a shutdown/error occurs
## locked_while_printing: True         # Preventing you from turning it off during a print
## on_when_job_queued: True            # Toggling the power On when you send a file from the slicer to print
## restart_klipper_when_powered: True
## restart_delay: 1
## bound_service: klipper              # Making sure the Klipper service is started/restarted with the toggle
##
################################################################################

## Mainsail macro buttons, to activate / deactivate printer shutdown at the end of printing:
[gcode_macro ACTIVATE_POWER_OFF]
gcode:
    UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK_ACT DURATION=60

[gcode_macro DEACTIVATE_POWER_OFF]
gcode:
    UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK_ACT DURATION=0


## Macros for power ON-OFF:
[delayed_gcode POWER_OFF_PRINTER_CHECK_ACT]
gcode:
   {% if printer.idle_timeout.state == "Idle" or printer.idle_timeout.state == "Ready" %}
      UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30
   {% else %}
      UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK_ACT DURATION=60
   {% endif %}

[delayed_gcode POWER_OFF_PRINTER_CHECK]
gcode:
  {% if printer.idle_timeout.state == "Idle" or printer.idle_timeout.state == "Ready" %}
     {% if printer.extruder.temperature < 50.0 and printer.heater_bed.temperature < 50.0 %}
        {% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
            UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
            _POWER_OFF_PRINTER
        {% else %}
           UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
        {% endif %}
     {% else %}
        {% if printer.idle_timeout.state == "Printing" %}
           UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
        {% else %}
           {% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
              UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
           {% else %}
              UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
           {% endif %}
        {% endif %}
     {% endif %}
  {% endif %}

[gcode_macro _POWER_OFF_PRINTER]
gcode:
  {action_call_remote_method("set_device_power",
                             device="printer",
                             state="off")}


######################################################################
# BED DANCE: Lowriding / Lowrider
######################################################################
## stepper_z - Left
## stepper_z1 - Rear
## stepper_z2 - Right

[gcode_macro Bed_Lowrider] 
gcode:
    SAVE_GCODE_STATE NAME=bed_dance
	G28 Z                                                                # Home Z
    G90                                                                  # Absolute                                   
	G1 Z10 F600                                                          # Initial Back off from nozzle and Start Point Position   
    ## (relative: z:0, z1:0, z2:0)	
    FORCE_MOVE STEPPER=stepper_z2 DISTANCE=10 VELOCITY=10 ACCEL=100      # RIGHT
	FORCE_MOVE STEPPER=stepper_z1 DISTANCE=10 VELOCITY=10 ACCEL=100      # REAR
    FORCE_MOVE STEPPER=stepper_z DISTANCE=75 VELOCITY=11 ACCEL=100       # LEFT
	G91                                                                  # Relative
	G1 Z30 F600                                                          # ALL down
    G1 Z-30 F600                                                         # ALL down
	G90                                                                  # Absolute
    ## (relative: z:-50, z1:0, z2:0)
    FORCE_MOVE STEPPER=stepper_z DISTANCE=-65 VELOCITY=11 ACCEL=100
    ## Restore GCODE:
	RESTORE_GCODE_STATE NAME=bed_dance
    G28 Z








 







 

