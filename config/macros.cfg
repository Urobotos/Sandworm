
## For more information about these macros, see: https://github.com/Urobotos/Sandworm/blob/master/README.md


###########################################################
#      Kliper Base macro for Mainsail main page macro button:
###########################################################
## To add a custom Klipper macro button (like the BED_MESH_CALIBRATE button) to the Mainsail page.
## Macros are numbered in the order needed to perform the entire calibration.

[gcode_macro Z_ENDSTOP_CALIBRATE_01]
description: Z Endstop Calibrate for Mainsail macro button
gcode:	
   Z_ENDSTOP_CALIBRATE

[gcode_macro PROBE_CALIBRATE_02]
description: Probe Calibrate for Mainsail macro button
gcode:	
   PROBE_CALIBRATE

[gcode_macro Z_TILT_ADJUST_03]
description: Z Tilt Adjust for Mainsail macro button
gcode:	
   Z_TILT_ADJUST

[gcode_macro BED_MESH_CALIBRATE_04]
description: Bed Mesh Calibrate for Mainsail macro button
gcode:	
   BED_MESH_CALIBRATE


###########################################################
#      Gcode FEATURES:
###########################################################

## podpora G2/G3
[gcode_arcs]        
resolution: 1.0

## For M118 messages to Mainsail command line:
[respond]            
default_type: echo
default_prefix: 

#[virtual_sdcard]     ## Include in mainsail_custom.cfg file
#path: ~/printer_data/gcodes/  

## Support for saving values, e.g. after printer restart:
[save_variables]     
filename: ~/printer_data/config/variables.cfg    

## Pauza
[pause_resume]
recover_velocity: 50   # (mm/s). Default is 50.0 mm/s.

[exclude_object]

## Skew korekce
[skew_correction]

[force_move]  # For Bedlowrider macro
enable_force_move: true


######################################################################
#      G28 Rename - Z Homing with preheated nozzle:
######################################################################

[gcode_macro G28]
description: G28 Rename - Z Homing with preheated nozzle
rename_existing: G28.1
variable_no_params: 0
variable_target_temp: 0
variable_axes: None
gcode:
   SET_GCODE_VARIABLE MACRO=G28 VARIABLE=no_params VALUE=0
   {% set param_keys = params.keys()|map('upper')|list %}
   {% set raw_axes = 'XYZ'|select('in', param_keys)|list %}
   {% set axes = raw_axes if raw_axes else ['X', 'Y', 'Z'] %}
   {% set safe_axes = raw_axes | select('in', ['X','Y','Z']) | list %}
   {% set homed_axes = printer.toolhead.homed_axes | default("") %}
   {% set z_requested = 'Z' in axes %}
   {% set actual_temp = printer.extruder.temperature | int %}
   {% set target_temp = printer.extruder.target | int %}
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
  
   {% set axis_str = axes | join("") %}
   {% set homing_msg = { 1: "üè† " ~ axis_str ~ " Homing...",
                         2: "üè† " ~ axis_str ~ " Nav√°dƒõn√≠...",
                         3: "üè† " ~ axis_str ~ " Referenzfahrt..." }.get(lang, "üè† " ~ axis_str ~ " Homing...") %}
   M118 { homing_msg }
   M117 {{1: "Homing...", 2: "Navadeni...", 3: "Referenzen"}.get(lang, "Homing...")}

   {% if z_requested %}
      {% if actual_temp < 100 %}
         SET_GCODE_VARIABLE MACRO=G28 VARIABLE=target_temp VALUE={target_temp}
         M117 {{1: "Temp wait...", 2: "Cekam na nahrati", 3: "Temp warten..."}.get(lang, "Temp wait...")}
         M118 {{1: "üå°Ô∏è Cold nozzle detected, heating to 100¬∞C...",
                2: "üå°Ô∏è Detekov√°na studen√° tryska ‚Äì nah≈ô√≠v√°m na 100¬∞C...",
                3: "üå°Ô∏è Kalte D√ºse erkannt ‚Äì heize auf 100¬∞C..."}.get(lang, "üå°Ô∏è Cold nozzle detected, heating to 100¬∞C...")}
         M104 S100
         {% if not raw_axes %}
            SET_GCODE_VARIABLE MACRO=G28 VARIABLE=no_params VALUE=1
         {% endif %}

         SET_GCODE_VARIABLE MACRO=G28 VARIABLE=axes VALUE="{ safe_axes }"
         UPDATE_DELAYED_GCODE ID=temp_homing DURATION=1
      {% else %}

        {% if raw_axes %}
           {% set x_true = " X" if ('X' in raw_axes or 'x' not in homed_axes) else '' %}
           {% set y_true = " Y" if ('Y' in raw_axes or 'y' not in homed_axes) else '' %}
           {% set cmd = "G28.1" ~ x_true ~ y_true %}
         {% else %} 
            {% set cmd = "G28.1 X Y" %} 
         {% endif %}

         {% set cmd = cmd ~ " Z" %}
         {cmd}

         M400
         M104 S{target_temp}
         {% set homing_done = { 1: "üè†‚úîÔ∏è " ~ axis_str ~ " Homing complete. Extruder target temp restored to previous:",
                                2: "üè†‚úîÔ∏è " ~ axis_str ~ " Nav√°dƒõn√≠ dokonƒçeno. C√≠lov√° teplota extrud√©ru byla obnovena na p≈ôedchoz√≠ch:",
                                3: "üè†‚úîÔ∏è " ~ axis_str ~ " Referenzfahrt abgeschlossen. Zieltemperatur des Extruders auf vorherigen Wert wiederhergestellt:" 
                                }.get(lang, "üè†‚úîÔ∏è " ~ axis_str ~ " Homing complete.") %}
         M118 { homing_done} { target_temp }¬∞C
         M117 {{1: "Homing complete", 2: "Navadeni dokon.", 3: "Homing fertig"}.get(lang, "Homing complete")}
         UPDATE_DELAYED_GCODE ID=clear_display DURATION=25
      {% endif %}
   {% else %}
      {% set cmd = "G28.1 " ~ (axes | join(" ")) %}
      {cmd}

      M400
      {% set homing_done = { 1: "üè† " ~ axis_str ~ " Homing complete.",
                             2: "üè† " ~ axis_str ~ " Nav√°dƒõn√≠ dokonƒçeno.",
                             3: "üè† " ~ axis_str ~ " Referenzfahrt abgeschlossen." }.get(lang, "üè† " ~ axis_str ~ " Homing complete.") %}
      M118 { homing_done}
      M117 {{1: "Homing complete", 2: "Navadeni dokon.", 3: "Homing fertig"}.get(lang, "Homing complete")} 

      UPDATE_DELAYED_GCODE ID=clear_display DURATION=25	  
   {% endif %}


[delayed_gcode temp_homing]
gcode:
   {% set actual_temp = printer.extruder.temperature | int %}
   {% if actual_temp < 100 %}
      UPDATE_DELAYED_GCODE ID=temp_homing DURATION=1
      # M118 DEBUG: actual temp in the loop: {actual_temp}
   {% else %}
      {% set lang = printer.save_variables.variables.lang | default(1) | int %}
      {% set no_params = printer['gcode_macro G28'].no_params | default(1) | int %}
      {% set homed_axes = printer.toolhead.homed_axes | default("") %}
      {% set axes_list = printer['gcode_macro G28'].axes | default(['Z']) %}
      {% set target_temp = printer['gcode_macro G28'].target_temp | default(0) | int %}
      UPDATE_DELAYED_GCODE ID=temp_homing DURATION=0

      {% if no_params == 0 %}
         {% set x_true = " X" if ('X' in axes_list or 'x' not in homed_axes) else '' %}
         {% set y_true = " Y" if ('Y' in axes_list or 'y' not in homed_axes) else '' %}
         {% set cmd = "G28.1" ~ x_true ~ y_true %}
      {% else %} 
         {% set cmd = "G28.1 X Y" %} 
      {% endif %}

      {% set cmd = cmd ~ " Z" %}
      {cmd}

     {% set axis_str = cmd | replace("G28.1", "") | trim | replace(" ", "") %}

      M400
      M104 S{target_temp}
      {% set homing_done = { 1: "üè†‚úîÔ∏è Preheated " ~ axis_str ~ " homing complete. Extruder target temp restored to previous:",
                             2: "üè†‚úîÔ∏è P≈ôedeh≈ô√°t√© " ~ axis_str ~ " nav√°dƒõn√≠ dokonƒçeno. C√≠lov√° teplota extrud√©ru byla obnovena na p≈ôedchoz√≠ch:",
                             3: "üè†‚úîÔ∏è Vorgeheiztes " ~ axis_str ~ " Referenzfahrt abgeschlossen. Zieltemperatur des Extruders auf vorherigen Wert wiederhergestellt:" 
                             }.get(lang, "üè†‚úîÔ∏è Preheated " ~ axis_str ~ " homing complete.") %}
      M118 { homing_done} { target_temp }¬∞C

      M117 {{1: "Homing complete", 2: "Navadeni dokon.", 3: "Homing fertig"}.get(lang, "Homing complete")}
      UPDATE_DELAYED_GCODE ID=clear_display DURATION=25

      SET_GCODE_VARIABLE MACRO=G28 VARIABLE=no_params VALUE=0
      SET_GCODE_VARIABLE MACRO=G28 VARIABLE=target_temp VALUE=0
   {% endif %}


######################################################################
#      Filament Runout Sensor and Runout Distance:
######################################################################
## Filament Sensor connected to Octopus Board pin: PG11
## Description: Adjustable delay for triggering PAUSE after activating the Filament sensor (to save filament).
## Distance (runout_distance variable) = Length (in mm) from Filament sensor to extruder gear (with a ~100mm buffer for manual filament removal), default 930 mm.
## To override or set the length of your PTFE distance delay (three options): 
##   1. Via the LCD display: Menu --> Setup --> Filament sansor --> Distance: 930 mm 
##   2. Or manually overwrite the <runout_distance> variable in the variables.cfg file in the path: 
##      variables.cfg --> runout_distance: 930 , 
##   3. Using a gcode in the Mainsail console: SAVE_VARIABLE VARIABLE=runout_distance VALUE=Your_new_value
##
## You can also deactivate the Runout Distance delay procedure and start PAUSE immediately when the Filament Sensor is activated via the LCD display menu
## (Setting deactivate is also available during printing).

[filament_switch_sensor Filament_Sensor]
switch_pin: PG11
pause_delay: 0.1
event_delay: 3.0
pause_on_runout: False
# insert_gcode: {action_respond_info("RUNOUT: Filament inserted")}
runout_gcode:
          runout_distance

## Filament Runout Distance macro:
[gcode_macro runout_distance]
description: Filament Runout Distance
variable_progress_bar_0: 0
variable_progress_bar_20: 0
variable_progress_bar_40: 0
variable_progress_bar_60: 0
variable_progress_bar_80: 0
variable_progress_bar_100: 0
variable_runout_distance: 930
variable_start_point: 0
variable_end_point: 0
gcode:
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   M118 {{1: "‚ö†Ô∏è Filament Sensor: Empty state!", 2: "‚ö†Ô∏è Senzor Filamentu: Pr√°zdn√Ω stav!", 3: "‚ö†Ô∏è Filamentsensor: Leerer Zustand!"}.get(lang, "filament runout!")}
   SET_LED LED=extruder RED=0.09 GREEN=0.0 BLUE=0.0 WHITE=0.0 INDEX=1   # Extruder Status LED
   {% set runout_distance_on_off = printer.save_variables.variables.runout_distance_on_off | default(1) | int %}
   {% set runout_distance = printer.save_variables.variables.runout_distance | default(930) | int %}
   {% set start_point = printer.print_stats.filament_used | int %}   
   {% set end_point = start_point + runout_distance | int %}  
   SET_GCODE_VARIABLE MACRO=runout_distance VARIABLE=runout_distance VALUE={runout_distance}
   SET_GCODE_VARIABLE MACRO=runout_distance VARIABLE=end_point VALUE={end_point}  
   SET_GCODE_VARIABLE MACRO=runout_distance VARIABLE=start_point VALUE={start_point} 
   {% for level in ['0', '20', '40', '60', '80', '100'] %}
      SET_GCODE_VARIABLE MACRO=runout_distance VARIABLE=progress_bar_{level} VALUE=0
   {% endfor %}
   {% if runout_distance_on_off == 1 %}	 
      UPDATE_DELAYED_GCODE ID=runout_check DURATION=1
   {% else %}
      M600
      SET_LED LED=extruder RED=0.09 GREEN=0.0 BLUE=0.0 WHITE=0.0 INDEX=1   # Extruder Status LED
      SET_LED_BLINK LED=lights RED=0.5 COUNT=3
      alert_beep                                                           # M300 Beeper
   {% endif %}

[delayed_gcode runout_check]
initial_duration: 0
gcode:
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   {% set progress_text = {1: "‚ö†Ô∏è Filament Runout at:", 2: "‚ö†Ô∏è Spu≈°tƒõn√≠ Pauzy za:", 3: "‚ö†Ô∏è Filament Auslauf bei:"}.get(lang, "Filament Runout at:") %}
   {% set runout = printer["gcode_macro runout_distance"] %}
   {% set start_point = runout.start_point | int %}
   {% set end_point = runout.end_point | int %}
   {% set runout_distance = runout.runout_distance | int %} 
   {% set length_used = printer.print_stats.filament_used | int %}
   {% set progress_bar = ((length_used - start_point) * 100 / runout_distance) | int %}
   {% set length_ctdown = end_point - length_used %}
   {% set progress_levels = {
       '0': "‚ÄÇ‚ÄÇ0% ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 100%",
      '20': " 20% ‚ñì‚ñì‚ñì‚ñì‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 100%",
      '40': " 40% ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 100%",
      '60': " 60% ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 100%",
      '80': " 80% ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñë‚ñë‚ñë‚ñë 100%",
     '100': "100% ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì 100%"   } %}
   {% if printer.print_stats.state == "printing" %}
     {% if length_used < end_point %}        
        M117 {{1: "Pause at:", 2: "Pauza za:", 3: "Pause bei:"}.get(lang, "Pause at:")} {length_ctdown} mm
        {% for level, bar in progress_levels.items() %}
           {% set var_name = "progress_bar_" ~ level %}
           {% set progress_var = printer["gcode_macro runout_distance"][var_name] | int %}
           {% if progress_bar >= level | int and progress_var == 0 %}
              M118 {progress_text} {bar}%
              SET_GCODE_VARIABLE MACRO=runout_distance VARIABLE={var_name} VALUE=1
           {% endif %}
        {% endfor %}
        UPDATE_DELAYED_GCODE ID=runout_check DURATION=1  
     {% else %}
        M118 {progress_text} 100% ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì 100%
        {% for level in ['0', '20', '40', '60', '80', '100'] %}
           SET_GCODE_VARIABLE MACRO=runout_distance VARIABLE=progress_bar_{level} VALUE=0
        {% endfor %} 
        UPDATE_DELAYED_GCODE ID=runout_check DURATION=0
        M600
        SET_LED LED=extruder RED=0.09 GREEN=0.0 BLUE=0.0 WHITE=0.0 INDEX=1   # Extruder Status LED
        SET_LED_BLINK LED=lights RED=0.5
        alert_beep                                                      # M300 Beeper
     {% endif %}
   {% else %}
      UPDATE_DELAYED_GCODE ID=runout_check DURATION=0                   # For exiting the loop (back door) if not printing.
      M117
   {% endif %}

          
######################################################################
#      Filament Change M600:
######################################################################
# M600: Filament Change. This macro will Pause the print, move the
# tool to the Park position, Unload 100mm filament and does not 
# turn off the Extruder heating. After filament has been changed,
# the printing can be resumed from its previous position via the "RESUME"
# Mainsail button.

[gcode_macro M600] 
description: Filament Change
gcode:
   SAVE_GCODE_STATE NAME=M600
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}    
   {% set target_temp = printer.extruder.target|default(200)| int %}
   {% set change_temp = params.TEMP|default(200)|int %}                 # For customize Change temp on Mainsail macro button (default 200¬∞C for PLA)
   {% if printer.idle_timeout.state == "Printing" %}                   
      M117 {{1: "Filament change", 2: "Vymena filamentu", 3: "Filamentwechsel"}.get(lang, "Filament change")}
      M118 {{1: "üßµüîÑ Filament Change...", 2: "üßµüîÑ V√Ωmƒõna Filamentu...", 3: "üßµüîÑ Filamentwechsel..."}.get(lang, "Filament change")}
      PAUSE                                                             
      FILAMENT_UNLOAD TEMP={target_temp}
   {% else %}
      M104 S{change_temp}
      FILAMENT_UNLOAD TEMP={change_temp}
   {% endif %}
   {% if printer.print_stats.state == "paused" or printer.print_stats.state == "printing" %}
         M117 {{1: "Insert new fil.", 2: "Vlozte novy fil.", 3: "Neues Fil einle"}.get(lang, "Insert new fil.")}
         M118 {{1: "Remove the remaining filament from the PTFE tube and insert new filament, fill the nozzle and continue printing using the RESUME button.",
                2: "Vyjmƒõte zb√Ωvaj√≠c√≠ filament z PTFE trubice a vlo≈æte nov√Ω filament, naplntƒõ trysku a pokraƒçujte v tisku pomoc√≠ RESUME tlaƒç√≠tka.",
                3: "Entfernen Sie das restliche Filament aus dem PTFE-Schlauch und legen Sie neues Filament ein, f√ºllen Sie die D√ºse und setzen Sie den Druckvorgang mit der Schaltfl√§che ‚ÄûRESUME‚Äú fort."
                }.get(lang, "Remove the remaining filament from the PTFE tube and insert new filament, fill the nozzle and continue printing using the RESUME button.")}
   {% else %}                                                         
      M117 {{1: "Insert new fil.", 2: "Vlozte novy fil.", 3: "Neues Fil einle"}.get(lang, "Insert new fil.")}
      M118 {{1: "Insert new filament and fill the nozzle.",
             2: "Vlo≈æte nov√Ω filament a naplntƒõ trysku.",
             3: "Neues Filament einsetzen und D√ºse f√ºllen."}.get(lang, "Insert new filament and fill the nozzle.")}
      UPDATE_DELAYED_GCODE ID=clear_display DURATION=25
   {% endif %}
   RESTORE_GCODE_STATE NAME=M600


################################################################################
#      Filament Load / Unload:
################################################################################

[gcode_macro FILAMENT_LOAD]
description: Filament Load 100mm
gcode:
   SAVE_GCODE_STATE NAME=filament_load
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   {% set target_temp = printer.extruder.target | int %}
   {% set load_temp = params.TEMP|default(200)|int %}                   # For customize Load temp via Mainsal macro button, default 200¬∞C for PLA
   M118 {{1: "üßµ‚§µÔ∏è Filament Load (At temperature:", 2: "üßµ‚§µÔ∏è Zav√°dƒõn√≠ Filamentu (P≈ôi teplotƒõ:", 3: "üßµ‚§µÔ∏è Filament Laden (Bei Temperatur:"}.get(lang, "Filament Load")} {load_temp}¬∞C)...
   {% if printer.pause_resume.is_paused  == False %}
      Park_Toolhead
   {% endif %}
   {% if printer.extruder.temperature < load_temp %}
      M117 {{1: "Heating Nozzle", 2: "Nahrivam trysku", 3: "Erhitzen der Duse"}.get(lang, "Heating Nozzle")}
      M118 {{1: "‚úíÔ∏èüî• Heating the nozzle to:", 2: "‚úíÔ∏èüî• Nah≈ô√≠v√°m trysku na:", 3: "‚úíÔ∏èüî• Aufheizen der D√ºse auf:"}.get(lang, "Heating Nozzle")} {load_temp}¬∞C...
      M109 S{load_temp}
   {% endif %}
   M117 {{1: "Loading filament", 2: "Zavadim filament", 3: "Filament laden"}.get(lang, "Loading filament")}  
   M118 {{1: "Loading Filament...", 2: "Zav√°d√≠m Filament...", 3: "Filament laden..."}.get(lang, "Loading filament")}
   M83
   G92 E0.0
   G1 E100 F240                                                         # Filament Load (100mm, 4mm/s)
   G92 E0.0                                                             
   M400                                                                 # Wait for current moves to finish (For the correct timing of displaying message below).

   M104 S{target_temp}
   M118 {{ 1: "‚úîÔ∏è Load Complete. Extruder target temp restored to previous:",
           2: "‚úîÔ∏è Filament zaveden. C√≠lov√° teplota extrud√©ru byla obnovena na p≈ôedchoz√≠ch:",
           3: "‚úîÔ∏è Filament geladen. Die Zieltemperatur des Extruders wurde auf den vorherigen Wert zur√ºckgesetzt:"
           }.get(lang, "‚úîÔ∏è Load Complete. Extruder target temp restored to previous:") } { target_temp }¬∞C
   M117 {{1: "Load Complete", 2: "Filament zaveden", 3: "Laden fertig"}.get(lang, "Load Complete")}
   UPDATE_DELAYED_GCODE ID=clear_display DURATION=25
   RESTORE_GCODE_STATE NAME=filament_load

[gcode_macro FILAMENT_UNLOAD]
description: Filament Unload 100mm
gcode:
   SAVE_GCODE_STATE NAME=filament_unload
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   {% set target_temp = printer.extruder.target | int %}
   {% set unload_temp = params.TEMP|default(200)|int %}                 # For customize Unload temp via Mainsal macro button, default 200¬∞C for PLA
   M118 {{1: "üßµ‚§¥Ô∏è Filament Unload (At temperature:", 2: "üßµ‚§¥Ô∏è V√Ωsun Filamentu (P≈ôi teplotƒõ:", 3: "üßµ‚§¥Ô∏è Filament Entladen (Bei Temperatur:"}.get(lang, "Filament Unload")} {unload_temp}¬∞C)...   
   {% if printer.pause_resume.is_paused  == False %}
      Park_Toolhead
   {% endif %}	
   {% if printer.extruder.temperature < unload_temp %}
      M117 {{1: "Heating Nozzle", 2: "Nahrivam trysku", 3: "Erhitzen der Duse"}.get(lang, "Heating Nozzle")}
      M118 {{1: "‚úíÔ∏èüî• Heating the nozzle to:", 2: "‚úíÔ∏èüî• Nah≈ô√≠v√°m trysku na:", 3: "‚úíÔ∏èüî• Aufheizen der D√ºse auf:"}.get(lang, "‚úíÔ∏èüî• Heating the nozzle to:")} {unload_temp}¬∞C...
      M109 S{unload_temp}
   {% endif %}
   M117 {{1: "Unloading fil.", 2: "Vysun filamentu", 3: "Filament entladen"}.get(lang, "Unloading fil.")}  
   M118 {{1: "Unloading Filament...", 2: "Vysouv√°m Filament...", 3: "Filament entladen..."}.get(lang, "Unloading Filament...")}
   M83                                                                  # Put the extruder into relative mode
   G92 E0.0                                                             # Reset the extruder at position zero
   G1 E7 F180                                                           # Initial Load (7mm, 3mm/s)
   G1 E-7 F300                                                          # Initial Unload (7mm, 5mm/s)
   G4 P5000                                                             # Delay 5 sec 
   G1 E-100 F480                                                        # Full Filament Unload (100mm, 8mm/s)
   G92 E0.0                                                             # Set E position (Reset the extruder again)
   M400                                                                 # Wait for current moves to finish (For the correct timing of displaying message below).
   M104 S{target_temp}
   M118 {{ 1: "‚úîÔ∏è Unload Complete. Extruder target temp restored to previous:",
           2: "‚úîÔ∏è Filament vysunut. C√≠lov√° teplota extrud√©ru byla obnovena na p≈ôedchoz√≠ch:",
           3: "‚úîÔ∏è Entladen abgeschlosse. Die Zieltemperatur des Extruders wurde auf den vorherigen Wert zur√ºckgesetzt:"
           }.get(lang, "‚úîÔ∏è Unload Complete. Extruder target temp restored to previous:") } { target_temp }¬∞C
   M117 {{1: "Unload Complete", 2: "Filament vysunut", 3: "Entladen abgeschlossen"}.get(lang, "Unload Complete")}
   UPDATE_DELAYED_GCODE ID=clear_display DURATION=25
   e_stepper_off                                                        # OFF E stepper for better initial manual insertion new filament into gear   
   RESTORE_GCODE_STATE NAME=filament_unload


################################################################################
#      Nozzle Clean (via Brush):
################################################################################

[gcode_macro Nozzle_Clean]
description: Wipe nozzle by brush
gcode:
   SAVE_GCODE_STATE NAME=nozzle_clean
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   M117 {{1: "Nozzle cleaning", 2: "Cisteni trysky", 3: "Dusenreinigung"}.get(lang, "Nozzle cleaning")}  
   M118 {{1: "Ô∏è‚úíÔ∏èüßπ Nozzle cleaning", 2: "‚úíÔ∏èüßπ ƒåi≈°tƒõn√≠ trysky", 3: "‚úíÔ∏èüßπ D√ºsenreinigung"}.get(lang, "‚úíÔ∏èüßπ Nozzle cleaning")}
   {% set target_temp = printer.extruder.target | int %}	             # Save Extruder target temp for restore on the end of this macro.
   {% set wipe_speed = 4800 %}                                          # Wipe speed in mm/min, (3000 = 50mm/s, 4800 = 80mm/s, 6000 = 100mm/s).
   {% set wipe_count = params.COUNT|default(1)|int %}                   # Adjustable params <COUNT> on macro button. Number of clean procedures over brush.
   {% if "xyz" not in printer.toolhead.homed_axes %}
      M117 {{1: "Homing first...", 2: "Prvne domu...", 3: "Zuerst Homing..."}.get(lang, "Homing first")} 
      M118 {{1: "!üè† Not Homed! - Running Auto-Homing...",
             2: "!üè† Nezn√°m√° pozice! - Spou≈°t√≠m XYZ Auto-Nav√°dƒõn√≠",
             3: "!üè† Nicht gehomed! - Automatisches Homing wird ausgef√ºhrt..."}.get(lang, "Homing first")}
      {% if printer.extruder.temperature < 140 %}
         M118 {{1: "üå°Ô∏è Cold nozzle detected, heating to 140¬∞C...",
                2: "üå°Ô∏è Detekov√°na studen√° tryska ‚Äì nah≈ô√≠v√°m na 140¬∞C...",
                3: "üå°Ô∏è Kalte D√ºse erkannt ‚Äì heize auf 140C"}.get(lang, "Temp wait")}
         M109 S140 
      {% endif %}
      G28
   {% endif %}
   {% if printer.toolhead.position.z < 10 %}
      G90
      G1 Z10 F600
   {% endif %}
   G90  
   G1 Y251.5 F2700                                                      # ‚ôû Chess knight movement style
   G1 X149 F2700
   G1 Z10 F600  
   {% if printer.extruder.temperature > 170 %}
      M400                                                              # Wait for current moves to finish (For the correct timing of displaying message below).
      M117 {{1: "Cooling Nozzle", 2: "Chlazeni trysky", 3: "Kuhlduse"}.get(lang, "Cooling Nozzlet")}
      M118 {{1: "‚ùÑÔ∏è Waiting for nozzle to cool down at 170¬∞C by Fan...",
             2: "‚ùÑÔ∏è ƒåek√°m na ochlazen√≠ trysky na 170¬∞C pomoc√≠ ventil√°toru...",
             3: "‚ùÑÔ∏è Warten, bis die D√ºse durch den Ventilator auf 170¬∞C abgek√ºhlt ist..."}.get(lang, "Cooling Nozzle")}
      M106 S255                                                         # Part cooling FAN ON at 100% (255 = 100%)
      M109 S170                                                         # Set Nozzle temp to 170¬∞C and wait for cooling down
      M106 S0                                                           # Part cooling FAN OFF
   {% else %}
      M117 {{1: "Heating Nozzle", 2: "Nahrivam trysku", 3: "Erhitzen der Duse"}.get(lang, "Heating Nozzle")}  
      M118 {{1: "‚úíÔ∏èüî• Heating the nozzle to 170¬∞C...", 2: "‚úíÔ∏èüî• Nah≈ô√≠v√°m trysku na 170¬∞C...", 3: "‚úíÔ∏èüî• Aufheizen der D√ºse auf 170¬∞C..."}.get(lang, "Heating Nozzle")}
      M109 S170
   {% endif %}
   M104 S0                                                              # Extruder target Temp to 0 no wait - start cooling at now.
   G1 Z0.6 F600                                                         # Go down to the brush clean level.
   {% for wipe in range (wipe_count) %}
      G91
      {% for move_right in range (14) %}                                ## Moves to the Right:          Start   ‚ñ°   /|   /|   /|   /|   >>  End
         G1 Y-11 F{wipe_speed}                                          # Relative positioning XYZ              |  / |  / |  / |  / |  / 
         G1 X3 Y11 F{wipe_speed}                                        # Y forward movement                    | /  | /  | /  | /  | / 
      {% endfor %}                                                      # XY movement right and backwards       |/   |/   |/   |/   |/  

      {% for move_left in range (14) %}                                 ## Moves to the Left:           End    <<   |\   |\   |\   |\   ‚ñ°   Start
         G1 Y-11 F{wipe_speed}                                          # Relative positioning XYZ               \  | \  | \  | \  | \  |
         G1 X-3 Y11 F{wipe_speed}                                       # Y forward movement                      \ |  \ |  \ |  \ |  \ |
      {% endfor %}                                                      # XY movement left and backwards           \|   \|   \|   \|   \|
      G1 X40 Y-11 F{wipe_speed}                                         #                       
      G1 X-40 Y11 F{wipe_speed}                                         #                               Start  ‚ñ°‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí>>  End   
   {% endfor %}                                                         #                               End    <<‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚ñ°  Start
   ## Removing filament leak from nozzle (second phase):
   M400                                                                 # Wait for current moves to finish (For the correct timing of displaying message below).
   M117 {{1: "Cooling Nozzle", 2: "Chlazeni trysky", 3: "Kuhlduse"}.get(lang, "Cooling Nozzle")} 
   M118 {{1: "‚ùÑÔ∏è Waiting for nozzle to cool down at 155¬∞C by Fan...",
          2: "‚ùÑÔ∏è ƒåek√°m na ochlazen√≠ trysky na 155¬∞C pomoc√≠ ventil√°toru...",
          3: "‚ùÑÔ∏è Warten, bis die D√ºse durch den Ventilator auf 155¬∞C abgek√ºhlt ist..."}.get(lang, "Cooling Nozzle")}
   M106 S255                                                            # Part cooling FAN ON at 100% (255 = 100%)
   M109 S155                                                            # Wait for nozzle cool down at 155¬∞C by fan
   M104 S0                                                              # Set Extruder target Temp to 0, no wait - start cooling at now.
   {% for wipe in range (wipe_count) %}
      G91
      {% for move_right in range (14) %}                                ## Moves to the Right:          Start   ‚ñ°   /|   /|   /|   /|   >>  End
         G1 Y-11 F{wipe_speed}                                          # Relative positioning XYZ              |  / |  / |  / |  / |  / 
         G1 X3 Y11 F{wipe_speed}                                        # Y forward movement                    | /  | /  | /  | /  | / 
      {% endfor %}                                                      # XY movement right and backwards       |/   |/   |/   |/   |/  

      {% for move_left in range (14) %}                                 ## Moves to the Left:           End    <<   |\   |\   |\   |\   ‚ñ°   Start
         G1 Y-11 F{wipe_speed}                                          # Relative positioning XYZ               \  | \  | \  | \  | \  |
         G1 X-3 Y11 F{wipe_speed}                                       # Y forward movement                      \ |  \ |  \ |  \ |  \ |
      {% endfor %}                                                      # XY movement left and backwards           \|   \|   \|   \|   \|
      G1 X40 Y-11 F{wipe_speed}                                         #                       
      G1 X-40 Y11 F{wipe_speed}                                         #                               Start  ‚ñ°‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí>>  End   
   {% endfor %}                                                         #                               End    <<‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚ñ°  Start   
   G90
   G1 Z10 F600
   M106 S0                                                              # Part cooling FAN Off
   M400                                                                 # Wait for current moves to finish (For the correct timing of displaying message below).
   M104 S{target_temp}
   M118 {{ 1: "‚úîÔ∏è Nozzle cleaning completed. Extruder target temp restored to previous:",
           2: "‚úîÔ∏è ƒåi≈°tƒõn√≠ trysky dokonƒçeno. C√≠lov√° teplota extrud√©ru byla obnovena na p≈ôedchoz√≠ch:",
           3: "‚úîÔ∏è D√ºsenreinigung abgeschlossen. Zieltemperatur des Extruders auf vorherigen Wert zur√ºckgesetzt:"
           }.get(lang, "‚úîÔ∏è Nozzle cleaning completed. Extruder target temp restored to previous:") } { target_temp }¬∞C
   M117 {{1: "Cleaning done", 2: "Cisteni dokonc.", 3: "Reinigung erled."}.get(lang, "Cleaning done")} 
   UPDATE_DELAYED_GCODE ID=clear_display DURATION=25
   RESTORE_GCODE_STATE NAME=nozzle_clean


################################################################################
#      Moves Macro:
################################################################################

[gcode_macro FAKE_POSITION]
description: Set Fake position: X100 Y100 Z100
gcode:
   SET_KINEMATIC_POSITION X=100 Y=100 Z=100
 
[gcode_macro steppers_off]
description: All steppers OFF
gcode:
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   M117 {{1: "Steppers off", 2: "Motory vypnuty", 3: "Motoren aus"}.get(lang, "Steppers off")}  
   M118 {{1: "‚õî Stepper motors off", 2: "‚õî Motory vypnuty", 3: "‚õî Schrittmotoren aus"}.get(lang, "Steppers off")}
   M84
   M18                                                                  # steppers off
   UPDATE_DELAYED_GCODE ID=clear_display DURATION=25                    # Clearing the LCD message after 25 seconds

[gcode_macro e_stepper_off]
description: E Stepper Off
gcode:
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   M117 {{1: "E stepper off", 2: "E motor vypnut", 3: "E motor aus"}.get(lang, "E stepper off")}  
   M118 {{1: "‚õî E stepper motor off", 2: "‚õî E motor vypnut", 3: "‚õî E motor aus"}.get(lang, "E stepper off")}
   SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
   UPDATE_DELAYED_GCODE ID=clear_display DURATION=25                    # Clearing the LCD message after 25 seconds


################################################################################
#      Park Toolhead (At front position):
################################################################################

[gcode_macro Park_Toolhead]
description: Park Toolhead 
gcode:
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   SAVE_GCODE_STATE NAME=park
   {% set zet_pos = printer.toolhead.position.z %}
   {% if "xy" not in printer.toolhead.homed_axes %}   
      G28 X Y
   {% endif %}
   M117 {{1: "Parking...", 2: "Parkuji...", 3: "Ich parke..."}.get(lang, "Parking")}  
   M118 {{1: "üÖøÔ∏è Parking toolhead...", 2: "üÖøÔ∏è Parkuji...", 3: "üÖøÔ∏è Ich parke..."}.get(lang, "Parking")}
   {% if zet_pos < 10 %}
      G90
      G1 Z10 F600
   {% endif %}
   G90
   G1 Y-10 F2700                                                        # ‚ôû Chess knight movement style
   G1 X50 F2700
   UPDATE_DELAYED_GCODE ID=clear_display DURATION=25
   RESTORE_GCODE_STATE NAME=park


################################################################################
#      Idle Timeout:
################################################################################

[idle_timeout]
timeout: 480  # 300 = 5min, 480 = 8min
gcode:
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   {% if printer.pause_resume.is_paused %}
      SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=idle_state VALUE=True    # For Mainsail_custom.cfg RESUME macro
      M117 {{1: "Hotend Off", 2: "Hotend Vypnut", 3: "Hotend AUS"}.get(lang, "Hotend Off")}  
      M118 {{1: "‚úíÔ∏è‚õî Hotend OFF", 2: "‚úíÔ∏è‚õî Hotend Vypnut", 3: "‚úíÔ∏è‚õî Hotend AUS"}.get(lang, "Hotend OFF")}
      M104 S0                                                           # Hotend OFF
      M106 S0                                                           # Part Cooling Fan OFF
      SET_LED_BLINK LED=lights GREEN=0.2
   {% else %}
      M117 {{1: "Idle Timeout", 2: "Vyprsel cas", 3: "Leerlauf-Timeout"}.get(lang, "Idle Timeout")}  
      M118 {{1: "üïí Idle Timeout", 2: "üïí ƒåas neƒçinosti vypr≈°el", 3: "üïí Leerlauf-Timeout"}.get(lang, "Idle Timeout")}	
      SET_LED_BLINK LED=lights GREEN=0.2                                # LED Lights Blinks
      TURN_OFF_HEATERS                                                  # All Heaters OFF
      M84                                                               # Steppers OFF
      M106 S0                                                           # Part Cooling Fan OFF
      UPDATE_DELAYED_GCODE ID=clear_display DURATION=25
   {% endif %}


################################################################################
#      Display cleer:
################################################################################
## Dispaly clear Command (with delay 25 sec):
## Usage in the macros: UPDATE_DELAYED_GCODE ID=clear_display DURATION=25

[delayed_gcode clear_display]
gcode:
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   M117 {{1: "Ready", 2: "Pripraveno", 3: "Bereit"}.get(lang, "Ready")}  


################################################################################
#      Remotely control printer power ON and OFF via Relay:
################################################################################
## The original code and setup instructions can be found at: https://github.com/tinntbg/auto-power-off-klipper 
## For remote control power ON/OFF by Relay add to moonraker.conf file codes below:
##
## [power printer]
## type: gpio
## pin: gpiochip0/gpio72               # can be revesed by "!" , BTT-PI GPIO pin PC8
## initial_state: off  
## off_when_shutdown: True             # Turning off when a shutdown/error occurs
## locked_while_printing: True         # Preventing you from turning it off during a print
## restart_klipper_when_powered: True
## restart_delay: 1
## bound_service: klipper              # Making sure the Klipper service is started/restarted with the toggle
##
################################################################################

## Mainsail macro buttons, to activate / deactivate printer shutdown at the end of printing:
[gcode_macro ACTIVATE_POWER_OFF]
variable_msg_only_once: 0
variable_deactivate: 0
gcode:
   {% set stats_state = printer.print_stats.state | string %}
   {% if stats_state == "printing" or stats_state == "paused" %}
      SET_GCODE_VARIABLE MACRO=ACTIVATE_POWER_OFF VARIABLE=deactivate=0
   {% endif %}    
   SET_GCODE_VARIABLE MACRO=ACTIVATE_POWER_OFF VARIABLE=msg_only_once VALUE=0
   UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK_ACT DURATION=60

[gcode_macro DEACTIVATE_POWER_OFF]
gcode:
   {% set stats_state = printer.print_stats.state | string %}
   {% if stats_state == "printing" or stats_state == "paused" %}
      SET_GCODE_VARIABLE MACRO=ACTIVATE_POWER_OFF VARIABLE=deactivate=1
   {% endif %} 	  
   UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK_ACT DURATION=0
   UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0

## Macros for Printer Power ON-OFF:
[delayed_gcode POWER_OFF_PRINTER_CHECK_ACT]
gcode:
   {% set idle_state = printer.idle_timeout.state | string %}
   {% if (idle_state == "Idle" or idle_state == "Ready") and printer.print_stats.state != "paused" %}
      UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
   {% else %}
      UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK_ACT DURATION=60
   {% endif %}   

[delayed_gcode POWER_OFF_PRINTER_CHECK]
gcode:
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   {% set idle_state = printer.idle_timeout.state | string %}
   {% set e_target = printer.extruder.target | float | round(1) %}
   {% set bed_target = printer.heater_bed.target | float | round(1) %}
   {% set msg_only_once = printer["gcode_macro ACTIVATE_POWER_OFF"].msg_only_once | default(1) | int %}
   {% set deactivate = printer["gcode_macro ACTIVATE_POWER_OFF"].deactivate | default(0) | int %}
   {% if msg_only_once == 0 %}
      M118 {{1: "‚ö° Printer shutdown is active: Waiting for the extruder to cool down to 50¬∞C, then the printer will be turned off.",
             2: "‚ö° Vypnut√≠ tisk√°rny je aktivn√≠: ƒåek√°m na ochlazen√≠ extruderu na 50¬∞C, pot√© se tisk√°rna vypne.",
             3: "‚ö° Druckerabschaltung ist aktiv: Warten Sie, bis der Extruder auf 50¬∞C abgek√ºhlt ist, dann wird der Drucker ausgeschaltet."}.get(lang, "Printer Shutdown - Enabled")}
      SET_GCODE_VARIABLE MACRO=ACTIVATE_POWER_OFF VARIABLE=msg_only_once VALUE=1  
   {% endif %}  
   {% if idle_state == "Idle" or idle_state == "Ready" %}
      {% if printer.extruder.temperature < 50.0 and printer.heater_bed.temperature < 50.0 %}
         {% if e_target == 0.0 and bed_target == 0.0 %}
            UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
            SET_GCODE_VARIABLE MACRO=ACTIVATE_POWER_OFF VARIABLE=msg_only_once VALUE=0
            _POWER_OFF_PRINTER        
         {% endif %}
      {% elif deactivate == 1 %}
         SET_GCODE_VARIABLE MACRO=ACTIVATE_POWER_OFF VARIABLE=deactivate=0
         UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
         M118 {{1: "‚ö° The scheduled printer shutdown has been canceled: Canceled by user.",
                2: "‚ö° Pl√°novan√© vypnut√≠ tisk√°rny bylo zru≈°eno: Zru≈°eno u≈æivatelem.",
                3: "‚ö° Die geplante Druckerabschaltung wurde abgebrochen: Vom Benutzer abgebrochen."}.get(lang, "Printer shutdown canceled")}	 
      {% elif e_target == 0.0 and bed_target == 0.0 %}
         UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2       
      {% elif e_target > 0.0 or bed_target > 0.0 %}
         UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
         M118 {{1: "‚ö° The scheduled printer shutdown has been canceled: Temperature interaction by the user.",
                2: "‚ö° Pl√°novan√© vypnut√≠ tisk√°rny bylo zru≈°eno: Teplotn√≠ interakce ze strany u≈æivatele.",
                3: "‚ö° Die geplante Druckerabschaltung wurde abgebrochen: Temperaturinteraktion durch den Benutzer."}.get(lang, "Printer shutdown canceled")}
      {% else %}
         UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
      {% endif %}	  
   {% elif idle_state == "Printing" %}
      UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
      M118 {{1: "‚ö° The scheduled printer shutdown has been canceled: User-side print interaction.",
             2: "‚ö° Pl√°novan√© vypnut√≠ tisk√°rny bylo zru≈°eno: Tiskov√° interakce ze strany u≈æivatele.",
             3: "‚ö° Die geplante Druckerabschaltung wurde abgebrochen: Benutzerseitige Druckinteraktion."}.get(lang, "Printer shutdown canceled")} 
   {% endif %}
   
[gcode_macro _POWER_OFF_PRINTER]
gcode:
   {action_call_remote_method("set_device_power", device="printer", state="off")}


