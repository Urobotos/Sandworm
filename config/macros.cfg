
## For more information about these macros, see: https://github.com/Urobotos/Sandworm/blob/master/README.md


###########################################################
#      Kliper Base macro for Mainsail main page macro button:
###########################################################
## To add a custom Klipper macro button (like the BED_MESH_CALIBRATE button) to the Mainsail page.
## Macros are numbered in the order needed to perform the entire calibration.

[gcode_macro Z_ENDSTOP_CALIBRATE_01]
description: Z Endstop Calibrate for Mainsail macro button
gcode:
   Z_ENDSTOP_CALIBRATE

[gcode_macro BL_TOUCH_CALIBRATE_02]
description: Probe Calibrate for Mainsail macro button
gcode:
   PROBE_CALIBRATE

[gcode_macro Z_TILT_ADJUST_03]
description: Z Tilt Adjust for Mainsail macro button
gcode:
   Z_TILT_ADJUST

[gcode_macro BED_MESH_CALIBRATE_04]
description: Bed Mesh Calibrate for Mainsail macro button
gcode:
   BED_MESH_CALIBRATE


###########################################################
#      Gcode FEATURES:
###########################################################

## Support for G2/G3 g-code commands
[gcode_arcs]
resolution: 0.6

## For M118 messages to Mainsail command line:
[respond]
default_type: echo
default_prefix: 

#[virtual_sdcard]     ## Include in mainsail_custom.cfg file
#path: ~/printer_data/gcodes/  

## Support for saving values, e.g. after printer restart:
[save_variables]     
filename: ~/printer_data/config/variables.cfg    

## Pause
[pause_resume]
recover_velocity: 50   # (mm/s). Default is 50.0 mm/s.

[exclude_object]

## Skew support
[skew_correction]

[force_move]
enable_force_move: true


######################################################################
#      G28 Rename - Z Homing with preheated nozzle:
######################################################################
## For forced Z cold homing, call G28 with parameter: SKIP=1, 
## for example: G28 Z SKIP=1 , G28 SKIP=1 etc... 

[gcode_macro G28]
description: G28 Rename - Z Homing with preheated nozzle
rename_existing: G28.1
gcode:
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   {% set skip_preheat = params.SKIP | default(0) | replace("=", "") | int %}
   {% set param_keys = params.keys()|map('upper')|list %}
   {% set raw_axes = 'XYZ'|select('in', param_keys)|list %}
   {% set axes = raw_axes if raw_axes else ['X', 'Y', 'Z'] %}
   {% set axis_str = axes | join("") %}
   {% set homed_axes = printer.toolhead.homed_axes | default("") %}
   {% set z_requested = 'Z' in axes %}
   {% set actual_temp = printer.extruder.temperature | int %}
   {% set target_temp = printer.extruder.target | int %}
   {% set homing_msg = { 1: "üè† " ~ axis_str ~ " Homing...",
                         2: "üè† " ~ axis_str ~ " Nav√°dƒõn√≠...",
                         3: "üè† " ~ axis_str ~ " Referenzfahrt..." 
                         }.get(lang, "üè† " ~ axis_str ~ " Homing...") %}
   M118 { homing_msg }
   M117 {{1: "Homing...", 2: "Navadeni...", 3: "Referenzen"}.get(lang, "Homing...")}

   {% if z_requested %}
      {% if actual_temp < 100 and skip_preheat == 0 %}
         M104 S100
         M117 {{1: "Temp wait...", 2: "Cekam na nahrati", 3: "Temp warten..."}.get(lang, "Temp wait...")}
         M118 {{1: "üå°Ô∏è Cold nozzle detected, heating to 100¬∞C...",
                2: "üå°Ô∏è Detekov√°na studen√° tryska, nah≈ô√≠v√°m na 100¬∞C...",
                3: "üå°Ô∏è Kalte D√ºse erkannt, heize auf 100¬∞C..."
                }.get(lang, "üå°Ô∏è Cold nozzle detected, heating to 100¬∞C...")}

         {% if raw_axes %}
            {% set x_true = " X" if ('X' in raw_axes or 'x' not in homed_axes) else '' %}
            {% set y_true = " Y" if ('Y' in raw_axes or 'y' not in homed_axes) else '' %}
            {% set cmd = "G28.1" ~ x_true ~ y_true %}
         {% else %} 
            {% set cmd = "G28.1 X Y" %} 
         {% endif %}

         {% set cmd = cmd ~ " Z" %}
         TEMPERATURE_WAIT SENSOR=extruder MINIMUM=100
         {cmd}

         M400
         M104 S{target_temp}
         {% set homing_done = { 1: "üè†‚úîÔ∏è Preheated " ~ axis_str ~ " homing complete. Extruder target temp restored to previous:",
                                2: "üè†‚úîÔ∏è P≈ôedeh≈ô√°t√© " ~ axis_str ~ " nav√°dƒõn√≠ dokonƒçeno. C√≠lov√° teplota extrud√©ru byla obnovena na p≈ôedchoz√≠ch:",
                                3: "üè†‚úîÔ∏è Vorgeheiztes " ~ axis_str ~ " Referenzfahrt abgeschlossen. Zieltemperatur des Extruders auf vorherigen Wert wiederhergestellt:" 
                                }.get(lang, "üè†‚úîÔ∏è Preheated " ~ axis_str ~ " homing complete. Extruder target temp restored to previous:") %}
         M118 { homing_done} { target_temp }¬∞C

         M117 {{1: "Homing complete", 2: "Navadeni splneno", 3: "Homing fertig"}.get(lang, "Homing complete")}
         UPDATE_DELAYED_GCODE ID=clear_display DURATION=25
      {% else %}
         {% if raw_axes %}
            {% set x_true = " X" if ('X' in raw_axes or 'x' not in homed_axes) else '' %}
            {% set y_true = " Y" if ('Y' in raw_axes or 'y' not in homed_axes) else '' %}
            {% set cmd = "G28.1" ~ x_true ~ y_true %}
         {% else %} 
            {% set cmd = "G28.1 X Y" %} 
         {% endif %}

         {% set cmd = cmd ~ " Z" %}
         {cmd}

         M400
         M104 S{target_temp}
         {% if skip_preheat == 1 %}
            {% set homing_done = { 1: "üè† " ~ axis_str ~ " Homing complete.",
                                   2: "üè† " ~ axis_str ~ " Nav√°dƒõn√≠ dokonƒçeno.",
                                   3: "üè† " ~ axis_str ~ " Referenzfahrt abgeschlossen." 
                                   }.get(lang, "üè† " ~ axis_str ~ " Homing complete.") %}
         {% else %}
            {% set homing_done = { 1: "üè†‚úîÔ∏è " ~ axis_str ~ " Homing complete. Extruder target temp restored to previous:",
                                   2: "üè†‚úîÔ∏è " ~ axis_str ~ " Nav√°dƒõn√≠ dokonƒçeno. C√≠lov√° teplota extrud√©ru byla obnovena na p≈ôedchoz√≠ch:",
                                   3: "üè†‚úîÔ∏è " ~ axis_str ~ " Referenzfahrt abgeschlossen. Zieltemperatur des Extruders auf vorherigen Wert wiederhergestellt:" 
                                   }.get(lang, "üè†‚úîÔ∏è " ~ axis_str ~ " Homing complete. Extruder target temp restored to previous:") %}
         {% endif %}
         M118 { homing_done} { target_temp }¬∞C
         M117 {{1: "Homing complete", 2: "Navadeni splneno", 3: "Homing fertig"}.get(lang, "Homing complete")}
         UPDATE_DELAYED_GCODE ID=clear_display DURATION=25
      {% endif %}
   {% else %}
      {% set cmd = "G28.1 " ~ (axes | join(" ")) %}
      {cmd}

      M400
      {% set homing_done = { 1: "üè† " ~ axis_str ~ " Homing complete.",
                             2: "üè† " ~ axis_str ~ " Nav√°dƒõn√≠ dokonƒçeno.",
                             3: "üè† " ~ axis_str ~ " Referenzfahrt abgeschlossen." 
                             }.get(lang, "üè† " ~ axis_str ~ " Homing complete.") %}
      M118 { homing_done}
      M117 {{1: "Homing complete", 2: "Navadeni splneno", 3: "Homing fertig"}.get(lang, "Homing complete")} 
      UPDATE_DELAYED_GCODE ID=clear_display DURATION=25	  
   {% endif %}


######################################################################
#      Filament Runout Sensor and Runout Distance:
######################################################################
## Filament Sensor connected to Octopus Board pin: PG11
## Description: Adjustable delay for triggering PAUSE after activating the Filament sensor (to save filament).
## Distance (runout_distance variable) = Length (in mm) from Filament sensor to extruder gear (with a ~100mm buffer for manual filament removal), default 930 mm.
## To override or set the length of your PTFE distance delay (three options): 
##   1. Via the LCD display: Menu --> Setup --> Filament sansor --> Distance: 930 mm 
##   2. Or manually overwrite the <runout_distance> variable in the variables.cfg file in the path: 
##      variables.cfg --> runout_distance: 930 , 
##   3. Using a gcode in the Mainsail console: SAVE_VARIABLE VARIABLE=runout_distance VALUE=Your_new_value
##
## You can also deactivate the Runout Distance delay procedure and start PAUSE immediately when the Filament Sensor is activated via the LCD display menu
## (Setting deactivate is also available during printing).

[filament_switch_sensor Filament_Sensor]
switch_pin: PG11
pause_delay: 0.1
event_delay: 3.0
pause_on_runout: False
# insert_gcode: {action_respond_info("RUNOUT: Filament inserted")}
runout_gcode:
          runout_distance

## Filament Runout Distance macro:
[gcode_macro runout_distance]
description: Filament Runout Distance
variable_progress_bar_0: 0
variable_progress_bar_20: 0
variable_progress_bar_40: 0
variable_progress_bar_60: 0
variable_progress_bar_80: 0
variable_progress_bar_100: 0
variable_runout_distance: 930
variable_start_point: 0
variable_end_point: 0
gcode:
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   M118 {{1: "‚ö†Ô∏è Filament Sensor: Empty state!", 2: "‚ö†Ô∏è Senzor Filamentu: Pr√°zdn√Ω stav!", 3: "‚ö†Ô∏è Filamentsensor: Leerer Zustand!"}.get(lang, "‚ö†Ô∏è Filament Sensor: Empty state!")}
   SET_LED LED=extruder RED=0.09 GREEN=0.0 BLUE=0.0 WHITE=0.0 INDEX=1   # Extruder Status LED
   {% set runout_distance_on_off = printer.save_variables.variables.runout_distance_on_off | default(1) | int %}
   {% set runout_distance = printer.save_variables.variables.runout_distance | default(930) | int %}
   {% set start_point = printer.print_stats.filament_used | int %}   
   {% set end_point = start_point + runout_distance | int %}  
   SET_GCODE_VARIABLE MACRO=runout_distance VARIABLE=runout_distance VALUE={runout_distance}
   SET_GCODE_VARIABLE MACRO=runout_distance VARIABLE=end_point VALUE={end_point}  
   SET_GCODE_VARIABLE MACRO=runout_distance VARIABLE=start_point VALUE={start_point} 
   {% for level in ['0', '20', '40', '60', '80', '100'] %}
      SET_GCODE_VARIABLE MACRO=runout_distance VARIABLE=progress_bar_{level} VALUE=0
   {% endfor %}
   {% if runout_distance_on_off == 1 %}	 
      UPDATE_DELAYED_GCODE ID=runout_check DURATION=1
   {% else %}
      M600
      SET_LED LED=extruder RED=0.09 GREEN=0.0 BLUE=0.0 WHITE=0.0 INDEX=1   # Extruder Status LED
      SET_LED_BLINK LED=lights RED=0.5 COUNT=3
      alert_beep                                                           # M300 Beeper
   {% endif %}

[delayed_gcode runout_check]
initial_duration: 0
gcode:
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   {% set progress_text = {1: "‚ö†Ô∏è Filament Runout at:", 2: "‚ö†Ô∏è Spot≈ôeba filamentu za:", 3: "‚ö†Ô∏è Filament Auslauf bei:"}.get(lang, "‚ö†Ô∏è Filament Runout at:") %}
   {% set runout = printer["gcode_macro runout_distance"] %}
   {% set start_point = runout.start_point | int %}
   {% set end_point = runout.end_point | int %}
   {% set runout_distance = runout.runout_distance | int %} 
   {% set length_used = printer.print_stats.filament_used | int %}
   {% set progress_bar = ((length_used - start_point) * 100 / runout_distance) | int %}
   {% set length_ctdown = end_point - length_used %}
   {% set progress_levels = {
       '0': "‚ÄÇ‚ÄÇ0% ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 100%",
      '20': " 20% ‚ñì‚ñì‚ñì‚ñì‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 100%",
      '40': " 40% ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 100%",
      '60': " 60% ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 100%",
      '80': " 80% ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñë‚ñë‚ñë‚ñë 100%",
     '100': "100% ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì 100%"   } %}
   {% if printer.print_stats.state == "printing" %}
     {% if length_used < end_point %}        
        M117 {{1: "Pause at:", 2: "Pauza za:", 3: "Pause bei:"}.get(lang, "Pause at:")} {length_ctdown} mm
        {% for level, bar in progress_levels.items() %}
           {% set var_name = "progress_bar_" ~ level %}
           {% set progress_var = printer["gcode_macro runout_distance"][var_name] | int %}
           {% if progress_bar >= level | int and progress_var == 0 %}
              M118 {progress_text} {bar}
              SET_GCODE_VARIABLE MACRO=runout_distance VARIABLE={var_name} VALUE=1
           {% endif %}
        {% endfor %}
        UPDATE_DELAYED_GCODE ID=runout_check DURATION=1  
     {% else %}
        M118 {progress_text} 100% ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì 100%
        {% for level in ['0', '20', '40', '60', '80', '100'] %}
           SET_GCODE_VARIABLE MACRO=runout_distance VARIABLE=progress_bar_{level} VALUE=0
        {% endfor %} 
        UPDATE_DELAYED_GCODE ID=runout_check DURATION=0
        M600
        SET_LED LED=extruder RED=0.09 GREEN=0.0 BLUE=0.0 WHITE=0.0 INDEX=1   # Extruder Status LED
        SET_LED_BLINK LED=lights RED=0.5
        alert_beep                                                      # M300 Beeper
     {% endif %}
   {% else %}
      UPDATE_DELAYED_GCODE ID=runout_check DURATION=0                   # For exiting the loop (back door) if not printing.
      M117
   {% endif %}

          
######################################################################
#      Filament Change M600:
######################################################################
# M600: Filament Change. This macro will Pause the print, move the
# tool to the Park position, Unload 100mm filament and does not 
# turn off the Extruder heating. After filament has been changed,
# the printing can be resumed from its previous position via the "RESUME"
# Mainsail button.

[gcode_macro M600] 
description: Filament Change
gcode:
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}    
   {% set target_temp = printer.extruder.target|default(200)| int %}
   {% set change_temp = params.TEMP|default(200)|int %}                 # For customize Change temp on Mainsail macro button (default 200¬∞C for PLA)
   {% if printer.idle_timeout.state == "Printing" %}                   
      M117 {{1: "Filament change", 2: "Vymena filamentu", 3: "Filamentwechsel"}.get(lang, "Filament change")}
      M118 {{1: "üßµ Filament Change...", 2: "üßµ V√Ωmƒõna Filamentu...", 3: "üßµ Filamentwechsel..."}.get(lang, "üßµ Filament Change...")}
      PAUSE
      FILAMENT_UNLOAD TEMP={target_temp}
   {% else %}
      M104 S{change_temp}
      FILAMENT_UNLOAD TEMP={change_temp}
   {% endif %}
   {% if printer.print_stats.state == "paused" or printer.print_stats.state == "printing" %}
         M117 {{1: "Insert new fil.", 2: "Vlozte novy fil.", 3: "Neues Fil einle"}.get(lang, "Insert new fil.")}
         M118 {{1: "Remove the remaining filament from the PTFE tube, insert new filament, fill the nozzle and continue printing using the RESUME button.",
                2: "Vyjmƒõte zb√Ωvaj√≠c√≠ filament z PTFE trubice, vlo≈æte nov√Ω filament, napl≈àte trysku a pokraƒçujte v tisku pomoc√≠ RESUME tlaƒç√≠tka.",
                3: "Entfernen Sie das restliche Filament aus dem PTFE-Schlauch, legen Sie neues Filament ein, f√ºllen Sie die D√ºse und setzen Sie den Druckvorgang mit der Schaltfl√§che RESUME fort."
                }.get(lang, "Remove the remaining filament from the PTFE tube, insert new filament, fill the nozzle and continue printing using the RESUME button.")}
   {% else %}                                                         
      M117 {{1: "Insert new fil.", 2: "Vlozte novy fil.", 3: "Neues Fil einle"}.get(lang, "Insert new fil.")}
      M118 {{1: "Insert new filament and fill the nozzle.",
             2: "Vlo≈æte nov√Ω filament a naplntƒõ trysku.",
             3: "Neues Filament einsetzen und D√ºse f√ºllen."
             }.get(lang, "Insert new filament and fill the nozzle.")}
      UPDATE_DELAYED_GCODE ID=clear_display DURATION=25
   {% endif %}


################################################################################
#      Filament Load / Unload:
################################################################################

[gcode_macro FILAMENT_LOAD]
description: Filament Load 100mm
gcode:
   SAVE_GCODE_STATE NAME=filament_load
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   {% set load_temp = params.TEMP|default(200)|int %}                   # For customize Load temp via Mainsal macro button, default 200¬∞C for PLA
   {% set target_temp = printer.extruder.target | int %}
   {% set extruder_temp = printer.extruder.temperature | int %}

   {% if extruder_temp < load_temp %}
      M118 {{1: "üßµ Filament Load (At temperature", 
             2: "üßµ Zav√°dƒõn√≠ Filamentu (P≈ôi teplotƒõ", 
             3: "üßµ Filament Laden (Bei Temperatur"
             }.get(lang, "üßµ Filament Load (At temperature")} {load_temp}¬∞C)...
   {% else %}
      M118 {{1: "üßµ Filament Load...", 
             2: "üßµ Zav√°dƒõn√≠ Filamentu...", 
             3: "üßµ Filament Laden..."
             }.get(lang, "üßµ Filament Load...")}
   {% endif %}

   {% if printer.pause_resume.is_paused == False %}
      Park_Toolhead
   {% endif %}
   {% if extruder_temp < load_temp %}
      M117 {{1: "Heating Nozzle", 2: "Nahrivam trysku", 3: "Erhitzen der Duse"}.get(lang, "Heating Nozzle")}
      M118 {{1: "üî• Heating the nozzle to", 2: "üî• Nah≈ô√≠v√°m trysku na", 3: "üî• Aufheizen der D√ºse auf"}.get(lang, "üî• Heating the nozzle to")} {load_temp}¬∞C...
      M104 S{load_temp}
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM={load_temp}
   {% endif %}
   M117 {{1: "Loading filament", 2: "Zavadim filament", 3: "Filament laden"}.get(lang, "Loading filament")}  
   M118 {{1: "Loading Filament...", 2: "Zav√°d√≠m Filament...", 3: "Filament laden..."}.get(lang, "Loading Filament...")}
   M83
   G92 E0.0
   G1 E100 F240                                                         # Filament Load (100mm, 4mm/s)
   G92 E0.0                                                             
   M400                                                                 # Wait for current moves to finish (For the correct timing of displaying message below).
   M104 S{target_temp}
   M118 {{ 1: "üßµ‚úîÔ∏è Load Complete. Extruder target temp restored to previous:",
           2: "üßµ‚úîÔ∏è Filament zaveden. C√≠lov√° teplota extrud√©ru byla obnovena na p≈ôedchoz√≠ch:",
           3: "üßµ‚úîÔ∏è Filament geladen. Die Zieltemperatur des Extruders wurde auf den vorherigen Wert zur√ºckgesetzt:"
           }.get(lang, "üßµ‚úîÔ∏è Load Complete. Extruder target temp restored to previous:") } { target_temp }¬∞C
   M117 {{1: "Load Complete", 2: "Filament zaveden", 3: "Laden fertig"}.get(lang, "Load Complete")}
   UPDATE_DELAYED_GCODE ID=clear_display DURATION=25
   RESTORE_GCODE_STATE NAME=filament_load


[gcode_macro FILAMENT_UNLOAD]
description: Filament Unload 100mm
gcode:
   SAVE_GCODE_STATE NAME=filament_unload
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   {% set unload_temp = params.TEMP|default(200)|int %}                 # For customize Unload temp via Mainsal macro button, default 200¬∞C for PLA
   {% set target_temp = printer.extruder.target | int %}
   {% set extruder_temp = printer.extruder.temperature | int %}
   
   {% if extruder_temp < unload_temp %}  
      M118 {{1: "üßµ Filament Unload (At temperature", 
             2: "üßµ V√Ωsun Filamentu (P≈ôi teplotƒõ", 
             3: "üßµ Filament Entladen (Bei Temperatur"
             }.get(lang, "üßµ Filament Unload (At temperature")} {unload_temp}¬∞C)...
   {% else %}
      M118 {{1: "üßµ Filament Unload...", 
             2: "üßµ V√Ωsun Filamentu...", 
             3: "üßµ Filament Entladen..."
             }.get(lang, "üßµ Filament Unload...")}
   {% endif %}

   {% if printer.pause_resume.is_paused == False %}
      Park_Toolhead
   {% endif %}
   {% if extruder_temp < unload_temp %}
      M117 {{1: "Heating Nozzle", 2: "Nahrivam trysku", 3: "Erhitzen der Duse"}.get(lang, "Heating Nozzle")}
      M118 {{1: "üî• Heating the nozzle to", 2: "üî• Nah≈ô√≠v√°m trysku na", 3: "üî• Aufheizen der D√ºse auf"}.get(lang, "üî• Heating the nozzle to")} {unload_temp}¬∞C...
      M104 S{unload_temp}
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM={unload_temp}
   {% endif %}
   M117 {{1: "Unloading fil.", 2: "Vysun filamentu", 3: "Filament entladen"}.get(lang, "Unloading fil.")}  
   M118 {{1: "Unloading Filament...", 2: "Vysouv√°m Filament...", 3: "Filament entladen..."}.get(lang, "Unloading Filament...")}
   M83                                                                  # Put the extruder into relative mode
   G92 E0.0                                                             # Reset the extruder at position zero
   G1 E7 F180                                                           # Initial Load (7mm, 3mm/s)
   G1 E-7 F300                                                          # Initial Unload (7mm, 5mm/s)
   G4 P5000                                                             # Delay 5 sec 
   G1 E-100 F480                                                        # Full Filament Unload (100mm, 8mm/s)
   G92 E0.0                                                             # Set E position (Reset the extruder again)
   M400                                                                 # Wait for current moves to finish (For the correct timing of displaying message below)
   M104 S{target_temp}
   M118 {{ 1: "üßµ‚úîÔ∏è Unload Complete. Extruder target temp restored to previous:",
           2: "üßµ‚úîÔ∏è Filament vysunut. C√≠lov√° teplota extrud√©ru byla obnovena na p≈ôedchoz√≠ch:",
           3: "üßµ‚úîÔ∏è Entladen abgeschlosse. Die Zieltemperatur des Extruders wurde auf den vorherigen Wert zur√ºckgesetzt:"
           }.get(lang, "üßµ‚úîÔ∏è Unload Complete. Extruder target temp restored to previous:") } { target_temp }¬∞C
   M117 {{1: "Unload Complete", 2: "Filament vysunut", 3: "Entladen abgeschlossen"}.get(lang, "Unload Complete")}
   UPDATE_DELAYED_GCODE ID=clear_display DURATION=25
   e_stepper_off                                                        # OFF E stepper for better initial manual insertion new filament into gear
   RESTORE_GCODE_STATE NAME=filament_unload


################################################################################
#      Nozzle Clean (via Brush):
################################################################################

[gcode_macro Nozzle_Clean]
description: Wipe nozzle by brush
gcode:
   SAVE_GCODE_STATE NAME=nozzle_clean
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   {% set target_temp = printer.extruder.target | int %}                # Save Extruder target temp for restore on the end of this macro
   {% set wipe_speed = 4800 %}                                          # Wipe speed in mm/min, (3000 = 50mm/s, 4800 = 80mm/s, 6000 = 100mm/s)
   {% set wipe_count = params.COUNT|default(1)|int %}                   # Adjustable params <COUNT> on macro button. Number of clean procedures over brush
   {% set xy_speed = (printer.configfile.config.stepper_x.homing_speed | float) * 60 | int %}
   {% set z_speed = (printer.configfile.config.stepper_z.homing_speed | float) * 60 | int %}

   M117 {{1: "Nozzle cleaning", 2: "Cisteni trysky", 3: "Dusenreinigung"}.get(lang, "Nozzle cleaning")}  
   M118 {{1: "Ô∏èüßΩ Nozzle cleaning...", 2: "üßΩ ƒåi≈°tƒõn√≠ trysky...", 3: "üßΩ D√ºsenreinigung..."}.get(lang, "üßΩ Nozzle cleaning...")}
   
   {% if "xyz" not in printer.toolhead.homed_axes %}
      {% if printer.extruder.temperature < 140 %}
         M118 {{1: "üè† Unknown position and üå°Ô∏è Cold nozzle detected ‚Äî Heating the nozzle to 140¬∞C, then XYZ homing...",
                2: "üè† Nezn√°m√° pozice a üå°Ô∏è Detekov√°na studen√° tryska ‚Äî Nah≈ô√≠v√°m trysku na 140¬∞C, pot√© XYZ nav√°dƒõn√≠...",
                3: "üè† Unbekannte Position und üå°Ô∏è Kalte D√ºse erkannt ‚Äî Heize D√ºse auf 140‚ÄØ¬∞C, danach XYZ-Homing..."
                }.get(lang, "üè† Unknown position and üå°Ô∏è Cold nozzle detected ‚Äî Heating the nozzle to 140¬∞C, then XYZ homing...")}
         M104 S140
         TEMPERATURE_WAIT SENSOR=extruder MINIMUM=140
      {% else %}
      M117 {{1: "Homing first...", 2: "Prvne domu...", 3: "Zuerst Homing..."}.get(lang, "Homing first")} 
      M118 {{1: "üè† Unknown position! ‚Äî Running XYZ homing...",
             2: "üè† Nezn√°m√° pozice! ‚Äî Spou≈°t√≠m XYZ nav√°dƒõn√≠...",
             3: "üè† Unbekannte Position! ‚Äî XYZ-Anleitung wird gestartet..."
             }.get(lang, "üè† Unknown position! ‚Äî Running XYZ homing...")}
      {% endif %}
      G28
   {% elif printer.toolhead.position.z < 10 %}
      G90
      G1 Z10 F{z_speed}
   {% endif %}

   G90  
   G1 Y251.5 F{xy_speed}                                                # ‚ôû Chess knight movement style
   G1 X149 F{xy_speed}
   G1 Z10 F{z_speed} 
   {% if printer.extruder.temperature > 170 %}
      M400                                                              # Wait for current moves to finish (For the correct timing of displaying message below)
      M117 {{1: "Cooling Nozzle", 2: "Chlazeni trysky", 3: "Kuhlduse"}.get(lang, "Cooling Nozzlet")}
      M118 {{1: "‚ùÑÔ∏è Waiting for nozzle to cool down at 170¬∞C by Fan...",
             2: "‚ùÑÔ∏è ƒåek√°m na ochlazen√≠ trysky na 170¬∞C pomoc√≠ ventil√°toru...",
             3: "‚ùÑÔ∏è Warten, bis die D√ºse durch den Ventilator auf 170¬∞C abgek√ºhlt ist..."
             }.get(lang, "‚ùÑÔ∏è Waiting for nozzle to cool down at 170¬∞C by Fan...")}
      M106 S255                                                         # Part cooling FAN ON at 100% (255 = 100%)
      M104 S170                                                         # Set Nozzle temp to 170¬∞C and wait for cooling down
      TEMPERATURE_WAIT SENSOR=extruder MAXIMUM=170
      M106 S0                                                           # Part cooling FAN OFF
   {% else %}
      M117 {{1: "Heating Nozzle", 2: "Nahrivam trysku", 3: "Erhitzen der Duse"}.get(lang, "Heating Nozzle")}  
      M118 {{1: "üî• Heating the nozzle to 170¬∞C...", 2: "üî• Nah≈ô√≠v√°m trysku na 170¬∞C...", 3: "üî• Aufheizen der D√ºse auf 170¬∞C..."}.get(lang, "üî• Heating the nozzle to 170¬∞C...")}
      M104 S170
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM=170
   {% endif %}
   M104 S0                                                              # Extruder target Temp to 0 no wait - start cooling at now.
   G1 Z0.6 F{z_speed}                                                   # Go down to the brush clean level.
   {% for wipe in range (wipe_count) %}
      G91
      {% for move_right in range (14) %}                                ## Moves to the Right:          Start   ‚ñ°   /|   /|   /|   /|   >>  End
         G1 Y-11 F{wipe_speed}                                          # Relative positioning XYZ              |  / |  / |  / |  / |  / 
         G1 X3 Y11 F{wipe_speed}                                        # Y forward movement                    | /  | /  | /  | /  | / 
      {% endfor %}                                                      # XY movement right and backwards       |/   |/   |/   |/   |/  

      {% for move_left in range (14) %}                                 ## Moves to the Left:           End    <<   |\   |\   |\   |\   ‚ñ°   Start
         G1 Y-11 F{wipe_speed}                                          # Relative positioning XYZ               \  | \  | \  | \  | \  |
         G1 X-3 Y11 F{wipe_speed}                                       # Y forward movement                      \ |  \ |  \ |  \ |  \ |
      {% endfor %}                                                      # XY movement left and backwards           \|   \|   \|   \|   \|
      G1 X40 Y-11 F{wipe_speed}                                         #                       
      G1 X-40 Y11 F{wipe_speed}                                         #                               Start  ‚ñ°‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí>>  End
   {% endfor %}                                                         #                               End    <<‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚ñ°  Start
   ## Removing filament leak from nozzle (second phase):
   M400                                                                 # Wait for current moves to finish (For the correct timing of displaying message below).
   M117 {{1: "Cooling Nozzle", 2: "Chlazeni trysky", 3: "Kuhlduse"}.get(lang, "Cooling Nozzle")} 
   M118 {{1: "‚ùÑÔ∏è Waiting for nozzle to cool down at 155¬∞C by Fan...",
          2: "‚ùÑÔ∏è ƒåek√°m na ochlazen√≠ trysky na 155¬∞C pomoc√≠ ventil√°toru...",
          3: "‚ùÑÔ∏è Warten, bis die D√ºse durch den Ventilator auf 155¬∞C abgek√ºhlt ist..."
          }.get(lang, "‚ùÑÔ∏è Waiting for nozzle to cool down at 155¬∞C by Fan...")}
   M106 S255                                                            # Part cooling FAN ON at 100% (255 = 100%)
   M109 S155                                                            # Wait for nozzle cool down at 155¬∞C by fan
   M104 S0                                                              # Set Extruder target Temp to 0, no wait - start cooling at now.
   {% for wipe in range (wipe_count) %}
      G91
      {% for move_right in range (14) %}                                ## Moves to the Right:          Start   ‚ñ°   /|   /|   /|   /|   >>  End
         G1 Y-11 F{wipe_speed}                                          # Relative positioning XYZ              |  / |  / |  / |  / |  / 
         G1 X3 Y11 F{wipe_speed}                                        # Y forward movement                    | /  | /  | /  | /  | / 
      {% endfor %}                                                      # XY movement right and backwards       |/   |/   |/   |/   |/  

      {% for move_left in range (14) %}                                 ## Moves to the Left:           End    <<   |\   |\   |\   |\   ‚ñ°   Start
         G1 Y-11 F{wipe_speed}                                          # Relative positioning XYZ               \  | \  | \  | \  | \  |
         G1 X-3 Y11 F{wipe_speed}                                       # Y forward movement                      \ |  \ |  \ |  \ |  \ |
      {% endfor %}                                                      # XY movement left and backwards           \|   \|   \|   \|   \|
      G1 X40 Y-11 F{wipe_speed}                                         #                       
      G1 X-40 Y11 F{wipe_speed}                                         #                               Start  ‚ñ°‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí>>  End
   {% endfor %}                                                         #                               End    <<‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚ñ°  Start
   G90
   G1 Z10 F{z_speed}
   M106 S0                                                              # Part cooling FAN Off
   M400                                                                 # Wait for current moves to finish (For the correct timing of displaying message below).
   M104 S{target_temp}
   M118 {{ 1: "üßΩ‚úîÔ∏è Nozzle cleaning completed. Extruder target temp restored to previous:",
           2: "üßΩ‚úîÔ∏è ƒåi≈°tƒõn√≠ trysky dokonƒçeno. C√≠lov√° teplota extrud√©ru byla obnovena na p≈ôedchoz√≠ch:",
           3: "üßΩ‚úîÔ∏è D√ºsenreinigung abgeschlossen. Zieltemperatur des Extruders auf vorherigen Wert zur√ºckgesetzt:"
           }.get(lang, "üßΩ‚úîÔ∏è Nozzle cleaning completed. Extruder target temp restored to previous:")} { target_temp }¬∞C
   M117 {{1: "Cleaning done", 2: "Cisteni dokonc.", 3: "Reinigung erled."}.get(lang, "Cleaning done")} 
   UPDATE_DELAYED_GCODE ID=clear_display DURATION=25
   RESTORE_GCODE_STATE NAME=nozzle_clean


[gcode_macro Quick_Nozzle_Clean]
description: Quick nozzle clean using a brush (for start print bed mesh procedures)
gcode:
   SAVE_GCODE_STATE NAME=quick_nozzle_clean
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   {% set target_temp = printer.extruder.target | int %}                # Save Extruder target temp for restore on the end of this macro
   {% set extruder_temp = printer.extruder.temperature | int %}
   {% set xy_speed = (printer.configfile.config.stepper_x.homing_speed | float) * 60 | int %}
   {% set z_speed = (printer.configfile.config.stepper_z.homing_speed | float) * 60 | int %}
   {% set fan_speed = ((printer.fan.speed |float|round(2)) * 255) | int %}        # Save speed of blower
   {% set wipe_speed = 4800 %}                                          # Wipe speed in mm/min, (3000 = 50mm/s, 4800 = 80mm/s, 6000 = 100mm/s)
   {% set wipe_count = params.COUNT|default(2)|int %}                   # Adjustable params <COUNT> on macro button. Number of clean procedures over brush

   M117 {{1: "Nozzle cleaning", 2: "Cisteni trysky", 3: "Dusenreinigung"}.get(lang, "Nozzle cleaning")}
   M118 {{1: "Ô∏èüßΩ Nozzle cleaning...", 2: "üßΩ ƒåi≈°tƒõn√≠ trysky...", 3: "üßΩ D√ºsenreinigung..."}.get(lang, "üßΩ Nozzle cleaning...")}
   {% if "xyz" not in printer.toolhead.homed_axes %}
      M117 {{1: "Homing first...", 2: "Prvne domu...", 3: "Zuerst Homing..."}.get(lang, "Homing first")} 
      M118 {{1: "üè† Unknown position! ‚Äî Running XYZ homing...",
             2: "üè† Nezn√°m√° pozice! ‚Äî Spou≈°t√≠m XYZ nav√°dƒõn√≠...",
             3: "üè† Unbekannte Position! ‚Äî XYZ-Anleitung wird gestartet..."
             }.get(lang, "üè† Unknown position! ‚Äî Running XYZ homing...")}
      G28
   {% endif %}

   SET_HEATER_TEMPERATURE HEATER=extruder TARGET=170
   G90  
   G1 Y251.5 F{xy_speed}                                                # ‚ôû Chess knight movement style
   G1 X149 F{xy_speed} 
   G1 Z10 F{z_speed}

   {% if extruder_temp > 170 %}
      M400                                                              # Wait for current moves to finish (For the correct timing of displaying message below).
      M117 {{1: "Cooling Nozzle", 2: "Chlazeni trysky", 3: "Kuhlduse"}.get(lang, "Cooling Nozzlet")}
      M118 {{1: "‚ùÑÔ∏è Waiting for nozzle to cool down at 170¬∞C by Fan...",
             2: "‚ùÑÔ∏è ƒåek√°m na ochlazen√≠ trysky na 170¬∞C pomoc√≠ ventil√°toru...",
             3: "‚ùÑÔ∏è Warten, bis die D√ºse durch den Ventilator auf 170¬∞C abgek√ºhlt ist..."
             }.get(lang, "‚ùÑÔ∏è Waiting for nozzle to cool down at 170¬∞C by Fan...")}
      M106 S255                                                         # Part cooling FAN ON at 100% (255 = 100%)
      TEMPERATURE_WAIT SENSOR=extruder MAXIMUM=170                      # Set Nozzle temp to 170¬∞C and wait for cooling down
   {% elif extruder_temp < 170 %}
      M117 {{1: "Heating Nozzle", 2: "Nahrivam trysku", 3: "Erhitzen der Duse"}.get(lang, "Heating Nozzle")}  
      M118 {{1: "üî• Heating the nozzle to 170¬∞C...", 2: "üî• Nah≈ô√≠v√°m trysku na 170¬∞C...", 3: "üî• Aufheizen der D√ºse auf 170¬∞C..."}.get(lang, "üî• Heating the nozzle to 170¬∞C...")}
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM=170
   {% endif %}

   G1 Z0.6 F{z_speed}                                                   # Go down to the brush clean level.
   M104 S{target_temp}                                                  # Restore Extruder temp to previous
   M106 S255                                                            # Part cooling FAN ON at 100% (255 = 100%)
   {% for wipe in range (wipe_count) %}
      G91
      G1 X40 Y-11 F{wipe_speed}                                         # Start  ‚ñ°‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí>>  End
      G1 X-40 Y11 F{wipe_speed}                                         # End    <<‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚àí‚ñ°  Start
   {% endfor %}
   G90
   G1 Z10 F{z_speed}
   M106 S{fan_speed}                                                    # Restore blower speed to previous
   M400                                                                 # Wait for current moves to finish (For the correct timing of displaying message below).
   M118 {{ 1: "üßΩ‚úîÔ∏è Nozzle cleaning completed", 2: "üßΩ‚úîÔ∏è ƒåi≈°tƒõn√≠ trysky dokonƒçeno", 3: "üßΩ‚úîÔ∏è D√ºsenreinigung abgeschlossen"}.get(lang, "üßΩ‚úîÔ∏è Nozzle cleaning completed")}
   M117 {{1: "Cleaning done", 2: "Cisteni dokonc.", 3: "Reinigung erled."}.get(lang, "Cleaning done")}
   RESTORE_GCODE_STATE NAME=quick_nozzle_clean


################################################################################
#      Moves Macro:
################################################################################

[gcode_macro FAKE_POSITION]
description: Set Fake position: X100 Y100 Z100
gcode:
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   SET_KINEMATIC_POSITION X=100 Y=100 Z=100
   M118 üïäÔ∏è {{1: "FAKE position set to coordinates: X100 Y100 Z100", 
             2: "FAKE pozice nastavena na sou≈ôadnice: X100 Y100 Z100", 
             3: "FAKE-Position auf Koordinaten eingestellt: X100 Y100 Z100"
             }.get(lang, "FAKE position set to coordinates: X100 Y100 Z100")}

[gcode_macro steppers_off]
description: All steppers OFF
gcode:
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   M117 {{1: "Steppers off", 2: "Motory vypnuty", 3: "Motoren aus"}.get(lang, "Steppers off")}  
   M118 {{1: "‚õî Stepper motors off", 2: "‚õî Motory vypnuty", 3: "‚õî Schrittmotoren aus"}.get(lang, "‚õî Stepper motors off")}
   M84
   M18                                                                  # steppers off
   UPDATE_DELAYED_GCODE ID=clear_display DURATION=25                    # Clearing the LCD message after 25 seconds

[gcode_macro e_stepper_off]
description: E Stepper Off
gcode:
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   M117 {{1: "E stepper off", 2: "E motor vypnut", 3: "E motor aus"}.get(lang, "E stepper off")}  
   M118 {{1: "‚õî E stepper motor off", 2: "‚õî E motor vypnut", 3: "‚õî E motor aus"}.get(lang, "‚õî E stepper motor off")}
   SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
   UPDATE_DELAYED_GCODE ID=clear_display DURATION=25                    # Clearing the LCD message after 25 seconds


################################################################################
#      Park Toolhead (At front position):
################################################################################

[gcode_macro Park_Toolhead]
description: Park Toolhead
gcode:
   SAVE_GCODE_STATE NAME=park
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   {% set xy_speed = (printer.configfile.config.stepper_x.homing_speed | float) * 60 | int %}
   {% set z_speed = (printer.configfile.config.stepper_z.homing_speed | float) * 60 | int %}
   {% set pos = printer.toolhead.position %}
   {% set homed = printer.toolhead.homed_axes |default("None") | string %}
   {% set x = pos.x|float %}
   {% set y = pos.y|float %}
   {% set z = pos.z|float %}

   {% set x_park = 50 %}
   {% set y_park = -10 %}
   {% set epsilon = 0.5 %}
   {% set is_parked = (x >= x_park - epsilon and x <= x_park + epsilon) and
                      (y >= y_park - epsilon and y <= y_park + epsilon) %}

   {% if "xy" not in homed %}
      G28 X Y
   {% elif "z" in homed and z < 10 %}
      G90
      G1 Z10 F{z_speed}
   {% endif %}

   {% if not is_parked %}
      M117 {{1: "Parking...", 2: "Parkuji...", 3: "Ich parke..."}.get(lang, "Parking...")}
      M118 {{1: "üÖøÔ∏è Parking toolhead...", 2: "üÖøÔ∏è Parkuji...", 3: "üÖøÔ∏è Ich parke..."}.get(lang, "üÖøÔ∏è Parking toolhead...")}
   {% endif %}

   G90
   G1 Y-10 F{xy_speed}
   G1 X50 F{xy_speed}
   UPDATE_DELAYED_GCODE ID=clear_display DURATION=25
   RESTORE_GCODE_STATE NAME=park


################################################################################
#      Idle Timeout:
################################################################################

[idle_timeout]
timeout: 600                                                            # 300s = 5min, 480s = 8min, 600s = 10min
gcode:
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   {% if printer.pause_resume.is_paused %}
      SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=idle_state VALUE=True    # For Mainsail_custom.cfg RESUME macro
      M117 {{1: "Hotend Off", 2: "Hotend Vypnut", 3: "Hotend AUS"}.get(lang, "Hotend Off")}  
      M118 {{1: "‚õî Hotend OFF", 2: "‚õî Hotend Vypnut", 3: "‚õî Hotend AUS"}.get(lang, "‚õî Hotend OFF")}
      M104 S0                                                           # Hotend OFF
      M106 S0                                                           # Part Cooling Fan OFF
      SET_LED_BLINK LED=lights GREEN=0.2
   {% else %}
      M117 {{1: "Idle Timeout", 2: "Vyprsel cas", 3: "Leerlauf-Timeout"}.get(lang, "Idle Timeout")}  
      M118 {{1: "üïí Idle Timeout", 2: "üïí ƒåas neƒçinosti vypr≈°el", 3: "üïí Leerlauf-Timeout"}.get(lang, "üïí Idle Timeout")}	
      SET_LED_BLINK LED=lights GREEN=0.2                                # LED Lights Blinks
      TURN_OFF_HEATERS                                                  # All Heaters OFF
      M84                                                               # Steppers OFF
      M106 S0                                                           # Part Cooling Fan OFF
      M141 S0                                                           # Chamber colling OFF
      nozzle_led_off                                                    # Extruder nozzle LED OFF
      UPDATE_DELAYED_GCODE ID=clear_display DURATION=25
   {% endif %}


################################################################################
#      Remotely control printer power ON and OFF via Relay:
################################################################################
## The original code and setup instructions can be found at: https://github.com/tinntbg/auto-power-off-klipper 
## For remote control power ON/OFF by Relay add to moonraker.conf file codes below (without "## " characters):
##
## [power printer]
## type: gpio
## pin: gpiochip0/gpio72               # can be revesed by "!" , BTT-PI GPIO pin PC8
## initial_state: off  
## off_when_shutdown: True             # Turning off when a shutdown/error occurs
## locked_while_printing: True         # Preventing you from turning it off during a print
## restart_klipper_when_powered: True
## restart_delay: 1
## bound_service: klipper              # Making sure the Klipper service is started/restarted with the toggle
##
################################################################################

## Mainsail macro buttons: Activation and Deactivation (To turn off/disable turn off the printer at the end of printing).
## The ACTIVATE_POWER_OFF macro can also be used directly in the End G-code:

[gcode_macro ACTIVATE_POWER_OFF]
variable_msg_only_once: 0
variable_deactivate: 0
gcode:
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   {% set e_target = printer.extruder.target | float | round(1) %}
   {% set state = printer.print_stats.state | string %}
   SET_GCODE_VARIABLE MACRO=ACTIVATE_POWER_OFF VARIABLE=msg_only_once VALUE=0
   UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK_ACT DURATION=0
   UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0

   {% if e_target > 0 %}
      SET_GCODE_VARIABLE MACRO=ACTIVATE_POWER_OFF VARIABLE=deactivate VALUE=0
   {% endif %}

   {% if state == "cancelled" %}    # When manualy run ACTIVATE button after canceling print --> Run the second delayed loop instantly and do not fall into the exit door of the first loop
      UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0.5
   {% else %}
      UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK_ACT DURATION=0.5
      M118 {{1: "‚ö° The scheduled printer shutdown at the end of printing is enabled.",
             2: "‚ö° Pl√°novan√© vypnut√≠ tisk√°rny na konci tisku je aktivov√°no.",
             3: "‚ö° Das geplante Herunterfahren des Druckers am Ende des Druckvorgangs ist aktiviert."
             }.get(lang, "‚ö° The scheduled printer shutdown at the end of printing is enabled.")}
   {% endif %}

[gcode_macro DEACTIVATE_POWER_OFF]
gcode:
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   {% set state = printer.print_stats.state | string %}
   UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK_ACT DURATION=0
   UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0

   {% if state == "printing" or state == "paused" %}
      SET_GCODE_VARIABLE MACRO=ACTIVATE_POWER_OFF VARIABLE=deactivate VALUE=1
      M118 {{1: "‚ö° The printer's scheduled shutdown at the end of printing has been canceled.",
             2: "‚ö° Pl√°novan√© vypnut√≠ tisk√°rny na konci tisku bylo zru≈°eno.",
             3: "‚ö° Das geplante Herunterfahren des Druckers am Ende des Druckvorgangs wurde abgebrochen."
             }.get(lang, "‚ö° The printer's scheduled shutdown at the end of printing has been canceled.")}
   {% else %}
      SET_GCODE_VARIABLE MACRO=ACTIVATE_POWER_OFF VARIABLE=deactivate VALUE=0
      M118 {{1: "‚ö° The printer shutdown has been canceled.",
             2: "‚ö° Vypnut√≠ tisk√°rny bylo zru≈°eno.",
             3: "‚ö° Das Herunterfahren des Druckers wurde abgebrochen."
             }.get(lang, "‚ö° The printer shutdown has been canceled.")}
   {% endif %}

## Delayed macros for Printer Power OFF:
[delayed_gcode POWER_OFF_PRINTER_CHECK_ACT]
gcode:
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   {% set deactivate = printer["gcode_macro ACTIVATE_POWER_OFF"].deactivate | default(0) | int %}
   {% set state = printer.print_stats.state | string %}

   {% if deactivate == 1 %}
      UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK_ACT DURATION=0
      UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
      SET_GCODE_VARIABLE MACRO=ACTIVATE_POWER_OFF VARIABLE=deactivate VALUE=0

      M118 {{1: "‚ö° The scheduled printer shutdown has been canceled: Canceled by user.",
             2: "‚ö° Pl√°novan√© vypnut√≠ tisk√°rny bylo zru≈°eno: Zru≈°eno u≈æivatelem.",
             3: "‚ö° Die geplante Druckerabschaltung wurde abgebrochen: Vom Benutzer abgebrochen."
             }.get(lang, "‚ö° The scheduled printer shutdown has been canceled: Canceled by user.")}

   {% elif state == "standby" or state == "complete" %}
      UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0.5
   {% elif state == "cancelled" %}
      SET_GCODE_VARIABLE MACRO=ACTIVATE_POWER_OFF VARIABLE=deactivate VALUE=0
      UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK_ACT DURATION=0
      UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
      M118 {{1: "‚ö° Printing has been canceled ‚Äì The scheduled printer shutdown is also canceled.", 
             2: "‚ö° Tisk byl zru≈°en - Ru≈°√≠m i pl√°novan√© vypnut√≠ tisk√°rny.",
             3: "‚ö° Drucken wurde abgebrochen ‚Äì Die geplante Druckerabschaltung wurde ebenfalls abgebrochen."
             }.get(lang, "‚ö° Printing has been canceled ‚Äì The scheduled printer shutdown is also canceled.")}
   {% else %}
      UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK_ACT DURATION=60
   {% endif %}

[delayed_gcode POWER_OFF_PRINTER_CHECK]
gcode:
   {% set lang = printer.save_variables.variables.lang | default(1) | int %}
   {% set state = printer.print_stats.state | string %}
   {% set e_target = printer.extruder.target | float | round(1) %}
   {% set bed_target = printer.heater_bed.target | float | round(1) %}
   {% set msg_only_once = printer["gcode_macro ACTIVATE_POWER_OFF"].msg_only_once | default(1) | int %}

   {% if msg_only_once == 0 %}
      M118 {{1: "‚ö° Printer shutdown is active: Waiting for the extruder to cool down to 50¬∞C, then the printer will be turned off.",
             2: "‚ö° Vypnut√≠ tisk√°rny je aktivn√≠: ƒåek√°m na ochlazen√≠ extruderu na 50¬∞C, pot√© se tisk√°rna vypne.",
             3: "‚ö° Druckerabschaltung ist aktiv: Warten Sie, bis der Extruder auf 50¬∞C abgek√ºhlt ist, dann wird der Drucker ausgeschaltet."
             }.get(lang, "‚ö° Printer shutdown is active: Waiting for the extruder to cool down to 50¬∞C, then the printer will be turned off.")}
      SET_GCODE_VARIABLE MACRO=ACTIVATE_POWER_OFF VARIABLE=msg_only_once VALUE=1
      UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK_ACT DURATION=0
   {% endif %}

   {% if state == "standby" or state == "complete" or state == "cancelled" %}
      {% if printer.extruder.temperature < 50.0 %}
         {% if e_target == 0.0 and bed_target == 0.0 %}
            UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
            SET_GCODE_VARIABLE MACRO=ACTIVATE_POWER_OFF VARIABLE=msg_only_once VALUE=0
            SET_GCODE_VARIABLE MACRO=ACTIVATE_POWER_OFF VARIABLE=deactivate VALUE=0
            _POWER_OFF_PRINTER        
         {% endif %}
      {% elif e_target == 0.0 and bed_target == 0.0 %}
         UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
      {% elif e_target > 0.0 or bed_target > 0.0 %}
         UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
         M118 {{1: "‚ö° The scheduled printer shutdown has been canceled: Temperature interaction by the user.",
                2: "‚ö° Pl√°novan√© vypnut√≠ tisk√°rny bylo zru≈°eno: Teplotn√≠ interakce ze strany u≈æivatele.",
                3: "‚ö° Die geplante Druckerabschaltung wurde abgebrochen: Temperaturinteraktion durch den Benutzer."
                }.get(lang, "‚ö° The scheduled printer shutdown has been canceled: Temperature interaction by the user.")}
      {% else %}
         UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
         SET_GCODE_VARIABLE MACRO=ACTIVATE_POWER_OFF VARIABLE=deactivate VALUE=0
      {% endif %}
   {% elif state == "printing" %}
      UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
      SET_GCODE_VARIABLE MACRO=ACTIVATE_POWER_OFF VARIABLE=deactivate VALUE=0
      M118 {{1: "‚ö° The scheduled printer shutdown has been canceled: User-side print interaction.",
             2: "‚ö° Pl√°novan√© vypnut√≠ tisk√°rny bylo zru≈°eno: Tiskov√° interakce ze strany u≈æivatele.",
             3: "‚ö° Die geplante Druckerabschaltung wurde abgebrochen: Benutzerseitige Druckinteraktion."
             }.get(lang, "‚ö° The scheduled printer shutdown has been canceled: User-side print interaction.")}
   {% endif %}

[gcode_macro _POWER_OFF_PRINTER]
gcode:
   {action_call_remote_method("set_device_power", device="printer", state="off")}


